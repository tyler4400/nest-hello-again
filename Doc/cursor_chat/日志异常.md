# nestå¸¸ç”¨çš„æ—¥å¿—åº“ä»‹ç»
_Exported on 2025/7/11 at GMT+8 16:07:42 from Cursor (1.1.6)_

---

**User**

è¿™æ˜¯ä¸€ä¸ªnestçš„å­¦ä¹ é¡¹ç›®ï¼Œ nestå¸¸ç”¨çš„æ—¥å¿—åº“æœ‰å“ªäº›

---

**Cursor**

æˆ‘æ¥å¸®æ‚¨äº†è§£ NestJS å¸¸ç”¨çš„æ—¥å¿—åº“ã€‚é¦–å…ˆè®©æˆ‘æŸ¥çœ‹ä¸€ä¸‹æ‚¨å½“å‰é¡¹ç›®ä¸­çš„æ—¥å¿—æ¨¡å—å®ç°ï¼Œç„¶åä¸ºæ‚¨ä»‹ç»å¸¸ç”¨çš„æ—¥å¿—åº“ã€‚

åŸºäºæ‚¨çš„ NestJS å­¦ä¹ é¡¹ç›®å’Œæˆ‘çœ‹åˆ°çš„ä»£ç ï¼Œæˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†ä»‹ç» NestJS ä¸­å¸¸ç”¨çš„æ—¥å¿—åº“ï¼š

## NestJS å¸¸ç”¨æ—¥å¿—åº“æ¦‚è¿°

### 1. **å†…ç½® Loggerï¼ˆé»˜è®¤ï¼‰**
NestJS è‡ªå¸¦çš„æ—¥å¿—ç³»ç»Ÿï¼Œæ‚¨åœ¨é¡¹ç›®ä¸­å·²ç»ä½¿ç”¨äº†ï¼š

```typescript
import { Logger } from '@nestjs/common';
private logger = new Logger(LogController.name);
```

**ç‰¹ç‚¹ï¼š**
- å¼€ç®±å³ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®
- æ”¯æŒä¸åŒæ—¥å¿—çº§åˆ«ï¼ˆerror, warn, log, debug, verboseï¼‰
- è‡ªåŠ¨æ·»åŠ æ—¶é—´æˆ³å’Œä¸Šä¸‹æ–‡ä¿¡æ¯
- é€‚åˆå°å‹é¡¹ç›®å’Œå¼€å‘ç¯å¢ƒ

### 2. **Pinoï¼ˆæ‚¨é¡¹ç›®ä¸­æ­£åœ¨ä½¿ç”¨ï¼‰**
ä»æ‚¨çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ‚¨å·²ç»é›†æˆäº† `nestjs-pino`ï¼š

```typescript
import { PinoLogger } from 'nestjs-pino';
```

**ä¼˜åŠ¿ï¼š**
- ğŸš€ **æé«˜æ€§èƒ½** - æ¯” Winston å¿« 5 å€ä»¥ä¸Š
- ğŸ“¦ **ä½å†…å­˜å ç”¨** - é€‚åˆé«˜å¹¶å‘åº”ç”¨
- ğŸ”§ **JSON æ ¼å¼è¾“å‡º** - ä¾¿äºæ—¥å¿—åˆ†æå’Œå¤„ç†
- âš¡ **å¼‚æ­¥æ—¥å¿—** - ä¸é˜»å¡ä¸»çº¿ç¨‹
- ğŸ¨ **å¼€å‘å‹å¥½** - æ”¯æŒ pino-pretty ç¾åŒ–è¾“å‡º

**æ‚¨çš„é…ç½®ç¤ºä¾‹ï¼š**
```typescript
LoggerModule.forRoot({
  pinoHttp: {
    transport: {
      targets: [
        process.env.NODE_ENV === 'development' 
          ? {
              level: 'info',
              target: 'pino-pretty',
              options: { colorize: true }
            }
          : {
              level: 'info',
              target: 'pino-roll',
              options: {
                file: join('logs', 'pino-log.txt'),
                frequency: 'daily',
                size: '10m',
                mkdir: true,
              }
            }
      ]
    }
  }
})
```

### 3. **Winston**
æœ€å—æ¬¢è¿çš„ Node.js æ—¥å¿—åº“ï¼ŒåŠŸèƒ½ä¸°å¯Œï¼š

**ä¼˜åŠ¿ï¼š**
- ğŸ”§ **é«˜åº¦å¯å®šåˆ¶** - æ”¯æŒå¤šç§ä¼ è¾“æ–¹å¼å’Œæ ¼å¼
- ğŸ“ **å¤šä¼ è¾“æ”¯æŒ** - å¯åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°ã€æ–‡ä»¶ã€æ•°æ®åº“ç­‰
- ğŸŒ **äº‘æœåŠ¡é›†æˆ** - æ”¯æŒ AWS CloudWatchã€Datadog ç­‰
- ğŸ› ï¸ **ä¸­é—´ä»¶æ”¯æŒ** - ä¸ Express æ— ç¼é›†æˆ
- ğŸ“š **ä¸°å¯Œç”Ÿæ€** - å¤§é‡æ’ä»¶å’Œæ‰©å±•

**å®‰è£…å’Œä½¿ç”¨ï¼š**
```bash
npm install winston nest-winston
```

```typescript
import { WinstonModule } from 'nest-winston';
import * as winston from 'winston';

// åœ¨ app.module.ts ä¸­é…ç½®
WinstonModule.forRoot({
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'app.log' })
  ]
})
```

### 4. **Bunyan**
ç»“æ„åŒ–æ—¥å¿—çš„å…ˆé©±ï¼Œä¸“æ³¨äº JSON æ ¼å¼ï¼š

**ç‰¹ç‚¹ï¼š**
- ğŸ“‹ **JSON ç»“æ„åŒ–æ—¥å¿—** - ä¾¿äºè§£æå’ŒæŸ¥è¯¢
- ğŸ” **CLI å·¥å…·** - å†…ç½®æ—¥å¿—æŸ¥çœ‹å™¨
- ğŸ—ï¸ **å­æ—¥å¿—å™¨** - æ”¯æŒæ¨¡å—åŒ–æ—¥å¿—ç®¡ç†
- ğŸ“Š **åºåˆ—åŒ–å™¨** - è‡ªå®šä¹‰å¯¹è±¡åºåˆ—åŒ–

### 5. **Morgan**
ä¸“é—¨ç”¨äº HTTP è¯·æ±‚æ—¥å¿—ï¼š

**ç‰¹ç‚¹ï¼š**
- ğŸŒ **HTTP ä¸“ç”¨** - ä¸“é—¨è®°å½• HTTP è¯·æ±‚
- ğŸ“ **é¢„å®šä¹‰æ ¼å¼** - å¤šç§æ—¥å¿—æ ¼å¼å¯é€‰
- ğŸ”§ **Express ä¸­é—´ä»¶** - ä¸ Express å®Œç¾é›†æˆ

## æ€§èƒ½å¯¹æ¯”

| åº“å | æ€§èƒ½ | å†…å­˜å ç”¨ | é…ç½®å¤æ‚åº¦ | åŠŸèƒ½ä¸°å¯Œåº¦ |
|------|------|----------|------------|------------|
| Pino | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| Winston | â­â­â­ | â­â­â­ | â­â­ | â­â­â­â­â­ |
| Bunyan | â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­ |
| å†…ç½® Logger | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­ |

## æ¨èé€‰æ‹©

**åŸºäºæ‚¨çš„é¡¹ç›®æƒ…å†µï¼Œæˆ‘å»ºè®®ï¼š**

1. **ç»§ç»­ä½¿ç”¨ Pino** - æ‚¨å·²ç»é…ç½®å¾—å¾ˆå¥½äº†
   - é€‚åˆå­¦ä¹ å’Œç”Ÿäº§ç¯å¢ƒ
   - æ€§èƒ½ä¼˜ç§€ï¼Œé…ç½®åˆç†

2. **å­¦ä¹  Winston** - ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
   - äº†è§£æ›´å¤šæ—¥å¿—åº“çš„ä½¿ç”¨æ–¹å¼
   - é€‚åˆå¤æ‚çš„ä¼ä¸šçº§åº”ç”¨

3. **ä¿ç•™å†…ç½® Logger** - ç”¨äºç®€å•åœºæ™¯
   - å¿«é€Ÿå¼€å‘å’Œè°ƒè¯•æ—¶ä½¿ç”¨

## æœ€ä½³å®è·µå»ºè®®

1. **æ—¥å¿—çº§åˆ«ä½¿ç”¨**ï¼š
   - `error`: ä¸¥é‡é”™è¯¯
   - `warn`: è­¦å‘Šä¿¡æ¯
   - `info`: ä¸€èˆ¬ä¿¡æ¯
   - `debug`: è°ƒè¯•ä¿¡æ¯

2. **æ•æ„Ÿä¿¡æ¯å¤„ç†**ï¼š
   - ä¸è¦è®°å½•å¯†ç ã€APIå¯†é’¥ç­‰æ•æ„Ÿæ•°æ®
   - ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—ä¾¿äºåˆ†æ

3. **ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
   - å¯ç”¨æ—¥å¿—è½®è½¬
   - è®¾ç½®åˆé€‚çš„æ—¥å¿—çº§åˆ«
   - è€ƒè™‘æ—¥å¿—èšåˆå’Œç›‘æ§

æ‚¨å½“å‰çš„ Pino é…ç½®å·²ç»å¾ˆå¥½åœ°ä½“ç°äº†è¿™äº›æœ€ä½³å®è·µï¼

```typescript
import { Logger } from '@nestjs/common';
private logger = new Logger(LogController.name);
```

```typescript
import { PinoLogger } from 'nestjs-pino';
```

```typescript
LoggerModule.forRoot({
  pinoHttp: {
    transport: {
      targets: [
        process.env.NODE_ENV === 'development' 
          ? {
              level: 'info',
              target: 'pino-pretty',
              options: { colorize: true }
            }
          : {
              level: 'info',
              target: 'pino-roll',
              options: {
                file: join('logs', 'pino-log.txt'),
                frequency: 'daily',
                size: '10m',
                mkdir: true,
              }
            }
      ]
    }
  }
})
```

```shellscript
npm install winston nest-winston
```

```typescript
import { WinstonModule } from 'nest-winston';
import * as winston from 'winston';

// åœ¨ app.module.ts ä¸­é…ç½®
WinstonModule.forRoot({
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'app.log' })
  ]
})
```

---

**User**

Winstonå¦‚ä½•é›†æˆï¼Œ å†è¯¦ç»†ä¸€ç‚¹ï¼Œæˆ‘ä¸æƒ³é›†æˆåˆ°appmoduleï¼Œ æƒ³é›†æˆåˆ°logmoudleä½œä¸ºå­¦ä¹ ç¤ºä¾‹

---

**Cursor**

æˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ `log.module.ts` ä¸­é›†æˆ Winstonï¼Œè®©æ‚¨åœ¨åŒä¸€ä¸ªæ¨¡å—ä¸­å­¦ä¹ å’Œå¯¹æ¯”ä¸åŒçš„æ—¥å¿—åº“ã€‚

## 1. å®‰è£… Winston ç›¸å…³ä¾èµ–

```bash
npm install winston nest-winston
```

## 2. ä¿®æ”¹ `log.module.ts`

è®©æˆ‘çœ‹çœ‹æ‚¨å½“å‰çš„æ¨¡å—é…ç½®ï¼Œç„¶åæ·»åŠ  Winstonï¼š

```shellscript
npm install winston nest-winston
```

ç°åœ¨æˆ‘æ¥ä¸ºæ‚¨æä¾›å®Œæ•´çš„ Winston é›†æˆæ–¹æ¡ˆï¼š

## ä¿®æ”¹åçš„ `log.module.ts`

```typescript
import { Module } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';
import { LoggerModule } from 'nestjs-pino';
import { WinstonModule } from 'nest-winston';
import { join } from 'node:path';
import * as winston from 'winston';

@Module({
  imports: [
    /**
     * è¿™éƒ¨åˆ†å­¦ä¹  nestjs-pino æ¨¡å—
     * https://github.com/iamolegga/nestjs-pino
     */
    LoggerModule.forRoot({
      pinoHttp: {
        transport: {
          targets: [
            process.env.NODE_ENV === 'development'
              ? {
                  level: 'info',
                  target: 'pino-pretty',
                  options: {
                    colorize: true, // æ ¼å¼åŒ– æ›´å¥½çœ‹ä¸€äº›
                  },
                }
              : {
                  level: 'info',
                  target: 'pino-roll',
                  // ä¸‹é¢è¿™ä¸ªé…ç½®æ˜¯ç”Ÿäº§ç¯å¢ƒå¯ç”¨æ—¥å¿—å­˜å‚¨çš„ç›¸å…³çš„é…ç½®
                  options: {
                    file: join('logs', 'pino-log.txt'),
                    frequency: 'daily', // æ‰“å°å‘¨æœŸ hourly
                    size: '10m', // å•ä¸ªæ–‡ä»¶å¤§å°ï¼Œ å¦‚æœè¶…å‡ºäº†å°±æ–°å»ºæ–‡ä»¶
                    mkdir: true,
                  },
                },
          ],
        },
      },
    }),

    /**
     * Winston æ—¥å¿—åº“é›†æˆå­¦ä¹ 
     * æä¾›æ›´çµæ´»çš„æ—¥å¿—é…ç½®å’Œå¤šç§ä¼ è¾“æ–¹å¼
     */
    WinstonModule.forRoot({
      level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
      
      // è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
      format: winston.format.combine(
        winston.format.timestamp({
          format: 'YYYY-MM-DD HH:mm:ss',
        }),
        winston.format.errors({ stack: true }),
        winston.format.json(),
        // æ·»åŠ è‡ªå®šä¹‰æ ¼å¼åŒ–
        winston.format.printf(({ level, message, timestamp, stack, ...meta }) => {
          let log = `${timestamp} [${level.toUpperCase()}]: ${message}`;
          if (stack) {
            log += `\n${stack}`;
          }
          if (Object.keys(meta).length > 0) {
            log += `\nMeta: ${JSON.stringify(meta, null, 2)}`;
          }
          return log;
        })
      ),

      // é…ç½®å¤šç§ä¼ è¾“æ–¹å¼
      transports: [
        // æ§åˆ¶å°è¾“å‡ºï¼ˆå¼€å‘ç¯å¢ƒå¯ç”¨å½©è‰²ï¼‰
        new winston.transports.Console({
          format: process.env.NODE_ENV === 'development'
            ? winston.format.combine(
                winston.format.colorize(),
                winston.format.simple()
              )
            : winston.format.json(),
        }),

        // é”™è¯¯æ—¥å¿—æ–‡ä»¶
        new winston.transports.File({
          filename: join('logs', 'winston-error.log'),
          level: 'error',
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
          maxsize: 5242880, // 5MB
          maxFiles: 10,
        }),

        // æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
        new winston.transports.File({
          filename: join('logs', 'winston-combined.log'),
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
          maxsize: 5242880, // 5MB  
          maxFiles: 15,
        }),

        // å¼€å‘ç¯å¢ƒé¢å¤–çš„è°ƒè¯•æ—¥å¿—
        ...(process.env.NODE_ENV === 'development'
          ? [
              new winston.transports.File({
                filename: join('logs', 'winston-debug.log'),
                level: 'debug',
                format: winston.format.combine(
                  winston.format.timestamp(),
                  winston.format.json(),
                  winston.format.prettyPrint()
                ),
              }),
            ]
          : []),
      ],

      // å¤„ç†æœªæ•è·çš„å¼‚å¸¸
      exceptionHandlers: [
        new winston.transports.File({
          filename: join('logs', 'winston-exceptions.log'),
        }),
      ],

      // å¤„ç†æœªæ•è·çš„ Promise æ‹’ç»
      rejectionHandlers: [
        new winston.transports.File({
          filename: join('logs', 'winston-rejections.log'),
        }),
      ],
    }),
  ],
  providers: [LogService],
  controllers: [LogController],
})
export class LogModule {}
```

## æ›´æ–° `log.controller.ts`

```typescript
import { Controller, Logger, Get, Inject } from '@nestjs/common';
import { LogService } from './log.service';
import { PinoLogger } from 'nestjs-pino';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { Logger as WinstonLogger } from 'winston';

@Controller('log')
export class LogController {
  private readonly nestLogger = new Logger(LogController.name);

  constructor(
    private readonly logService: LogService,
    private readonly pinoLogger: PinoLogger,
    @Inject(WINSTON_MODULE_PROVIDER) 
    private readonly winstonLogger: WinstonLogger,
  ) {
    this.nestLogger.log('æ—¥å¿—æ¨¡å—é›†æˆæˆåŠŸ');
    this.winstonLogger.info('Winston logger initialized successfully');
  }

  @Get('/')
  testDefaultLogger() {
    this.nestLogger.log('æµ‹è¯• NestJS å†…ç½® Logger');
    return this.logService.hello();
  }

  @Get('/pino')
  testPinoLogger() {
    this.pinoLogger.info('æµ‹è¯• Pino Logger - é«˜æ€§èƒ½æ—¥å¿—åº“');
    this.pinoLogger.debug('Pino debug message', { 
      userId: 12345, 
      action: 'test_pino' 
    });
    return {
      message: 'è¯·æ±‚ nestjs-pino logger æˆåŠŸ',
      performance: 'Pino is extremely fast!',
    };
  }

  @Get('/winston')
  testWinstonLogger() {
    // æµ‹è¯•ä¸åŒçš„æ—¥å¿—çº§åˆ«
    this.winstonLogger.info('æµ‹è¯• Winston Logger - åŠŸèƒ½ä¸°å¯Œçš„æ—¥å¿—åº“');
    this.winstonLogger.debug('Winston debug information', {
      userId: 67890,
      action: 'test_winston',
      metadata: { browser: 'Chrome', ip: '192.168.1.1' }
    });
    this.winstonLogger.warn('è¿™æ˜¯ä¸€ä¸ªè­¦å‘Šæ¶ˆæ¯', { 
      warning: 'Resource usage high' 
    });

    return {
      message: 'è¯·æ±‚ Winston logger æˆåŠŸ',
      features: 'Winston provides rich customization options!',
    };
  }

  @Get('/winston/error')
  testWinstonError() {
    try {
      // æ¨¡æ‹Ÿä¸€ä¸ªé”™è¯¯
      throw new Error('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯');
    } catch (error) {
      // Winston ä¼šè‡ªåŠ¨å¤„ç†é”™è¯¯å †æ ˆè·Ÿè¸ª
      this.winstonLogger.error('æ•è·åˆ°é”™è¯¯', {
        error: error.message,
        stack: error.stack,
        endpoint: '/winston/error',
        timestamp: new Date().toISOString(),
      });
      
      return {
        message: 'é”™è¯¯å·²è®°å½•åˆ° Winston',
        errorLogged: true,
      };
    }
  }

  @Get('/compare')
  compareLoggers() {
    const startTime = Date.now();
    
    // åŒæ—¶ä½¿ç”¨ä¸‰ç§æ—¥å¿—åº“è®°å½•ç›¸åŒä¿¡æ¯
    const logData = {
      userId: 999,
      action: 'compare_loggers',
      timestamp: new Date().toISOString(),
    };

    // NestJS å†…ç½® Logger
    this.nestLogger.log('æ—¥å¿—åº“æ€§èƒ½å¯¹æ¯”æµ‹è¯•', JSON.stringify(logData));
    
    // Pino Logger  
    this.pinoLogger.info('Performance comparison test', logData);
    
    // Winston Logger
    this.winstonLogger.info('Logger performance comparison', logData);

    const endTime = Date.now();
    
    return {
      message: 'ä¸‰ç§æ—¥å¿—åº“å¯¹æ¯”æµ‹è¯•å®Œæˆ',
      executionTime: `${endTime - startTime}ms`,
      loggers: ['NestJS Built-in', 'Pino', 'Winston'],
      recommendation: 'Check logs folder to see different outputs',
    };
  }
}
```

## æ›´æ–° `log.service.ts`

```typescript
import { Injectable, Inject } from '@nestjs/common';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { Logger as WinstonLogger } from 'winston';

@Injectable()
export class LogService {
  constructor(
    @Inject(WINSTON_MODULE_PROVIDER) 
    private readonly winstonLogger: WinstonLogger,
  ) {}

  hello() {
    this.winstonLogger.info('LogService.hello() method called');
    return {
      code: 0,
      data: [],
      msg: 'è¯·æ±‚ logger æˆåŠŸï¼',
    };
  }

  // æ¼”ç¤º Winston åœ¨ä¸šåŠ¡é€»è¾‘ä¸­çš„ä½¿ç”¨
  async simulateUserAction(userId: number, action: string) {
    this.winstonLogger.info('User action started', {
      userId,
      action,
      timestamp: new Date().toISOString(),
    });

    try {
      // æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡é€»è¾‘
      await new Promise(resolve => setTimeout(resolve, 100));
      
      this.winstonLogger.info('User action completed successfully', {
        userId,
        action,
        status: 'success',
        duration: '100ms',
      });

      return {
        code: 0,
        data: { userId, action },
        msg: 'ç”¨æˆ·æ“ä½œå®Œæˆ',
      };
    } catch (error) {
      this.winstonLogger.error('User action failed', {
        userId,
        action,
        error: error.message,
        status: 'failed',
      });

      return {
        code: 1,
        data: null,
        msg: 'ç”¨æˆ·æ“ä½œå¤±è´¥',
      };
    }
  }

  // æ¼”ç¤ºç»“æ„åŒ–æ—¥å¿—è®°å½•
  logBusinessEvent(eventType: string, data: any) {
    this.winstonLogger.info('Business event occurred', {
      eventType,
      data,
      source: 'LogService',
      timestamp: new Date().toISOString(),
    });
  }
}
```

## æµ‹è¯• Winston é›†æˆ

1. **å¯åŠ¨åº”ç”¨åï¼Œæµ‹è¯•ä¸åŒçš„ç«¯ç‚¹ï¼š**

```bash
# æµ‹è¯• Winston åŸºæœ¬åŠŸèƒ½
curl http://localhost:3000/log/winston

# æµ‹è¯• Winston é”™è¯¯å¤„ç†
curl http://localhost:3000/log/winston/error

# å¯¹æ¯”ä¸‰ç§æ—¥å¿—åº“
curl http://localhost:3000/log/compare
```

2. **æŸ¥çœ‹ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶ï¼š**

```bash
# æŸ¥çœ‹ logs ç›®å½•
ls -la logs/

# æŸ¥çœ‹ Winston ç»¼åˆæ—¥å¿—
cat logs/winston-combined.log

# æŸ¥çœ‹ Winston é”™è¯¯æ—¥å¿—
cat logs/winston-error.log

# å¼€å‘ç¯å¢ƒä¸‹æŸ¥çœ‹è°ƒè¯•æ—¥å¿—
cat logs/winston-debug.log
```

## Winston é…ç½®è¯¦è§£

### æ—¥å¿—çº§åˆ«ä¼˜å…ˆçº§
```
error: 0
warn:

```typescript
import { Module } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';
import { LoggerModule } from 'nestjs-pino';
import { WinstonModule } from 'nest-winston';
import { join } from 'node:path';
import * as winston from 'winston';

@Module({
  imports: [
    /**
     * è¿™éƒ¨åˆ†å­¦ä¹  nestjs-pino æ¨¡å—
     * https://github.com/iamolegga/nestjs-pino
     */
    LoggerModule.forRoot({
      pinoHttp: {
        transport: {
          targets: [
            process.env.NODE_ENV === 'development'
              ? {
                  level: 'info',
                  target: 'pino-pretty',
                  options: {
                    colorize: true, // æ ¼å¼åŒ– æ›´å¥½çœ‹ä¸€äº›
                  },
                }
              : {
                  level: 'info',
                  target: 'pino-roll',
                  // ä¸‹é¢è¿™ä¸ªé…ç½®æ˜¯ç”Ÿäº§ç¯å¢ƒå¯ç”¨æ—¥å¿—å­˜å‚¨çš„ç›¸å…³çš„é…ç½®
                  options: {
                    file: join('logs', 'pino-log.txt'),
                    frequency: 'daily', // æ‰“å°å‘¨æœŸ hourly
                    size: '10m', // å•ä¸ªæ–‡ä»¶å¤§å°ï¼Œ å¦‚æœè¶…å‡ºäº†å°±æ–°å»ºæ–‡ä»¶
                    mkdir: true,
                  },
                },
          ],
        },
      },
    }),

    /**
     * Winston æ—¥å¿—åº“é›†æˆå­¦ä¹ 
     * æä¾›æ›´çµæ´»çš„æ—¥å¿—é…ç½®å’Œå¤šç§ä¼ è¾“æ–¹å¼
     */
    WinstonModule.forRoot({
      level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
      
      // è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
      format: winston.format.combine(
        winston.format.timestamp({
          format: 'YYYY-MM-DD HH:mm:ss',
        }),
        winston.format.errors({ stack: true }),
        winston.format.json(),
        // æ·»åŠ è‡ªå®šä¹‰æ ¼å¼åŒ–
        winston.format.printf(({ level, message, timestamp, stack, ...meta }) => {
          let log = `${timestamp} [${level.toUpperCase()}]: ${message}`;
          if (stack) {
            log += `\n${stack}`;
          }
          if (Object.keys(meta).length > 0) {
            log += `\nMeta: ${JSON.stringify(meta, null, 2)}`;
          }
          return log;
        })
      ),

      // é…ç½®å¤šç§ä¼ è¾“æ–¹å¼
      transports: [
        // æ§åˆ¶å°è¾“å‡ºï¼ˆå¼€å‘ç¯å¢ƒå¯ç”¨å½©è‰²ï¼‰
        new winston.transports.Console({
          format: process.env.NODE_ENV === 'development'
            ? winston.format.combine(
                winston.format.colorize(),
                winston.format.simple()
              )
            : winston.format.json(),
        }),

        // é”™è¯¯æ—¥å¿—æ–‡ä»¶
        new winston.transports.File({
          filename: join('logs', 'winston-error.log'),
          level: 'error',
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
          maxsize: 5242880, // 5MB
          maxFiles: 10,
        }),

        // æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
        new winston.transports.File({
          filename: join('logs', 'winston-combined.log'),
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
          maxsize: 5242880, // 5MB  
          maxFiles: 15,
        }),

        // å¼€å‘ç¯å¢ƒé¢å¤–çš„è°ƒè¯•æ—¥å¿—
        ...(process.env.NODE_ENV === 'development'
          ? [
              new winston.transports.File({
                filename: join('logs', 'winston-debug.log'),
                level: 'debug',
                format: winston.format.combine(
                  winston.format.timestamp(),
                  winston.format.json(),
                  winston.format.prettyPrint()
                ),
              }),
            ]
          : []),
      ],

      // å¤„ç†æœªæ•è·çš„å¼‚å¸¸
      exceptionHandlers: [
        new winston.transports.File({
          filename: join('logs', 'winston-exceptions.log'),
        }),
      ],

      // å¤„ç†æœªæ•è·çš„ Promise æ‹’ç»
      rejectionHandlers: [
        new winston.transports.File({
          filename: join('logs', 'winston-rejections.log'),
        }),
      ],
    }),
  ],
  providers: [LogService],
  controllers: [LogController],
})
export class LogModule {}
```

```typescript
import { Module } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';
import { LoggerModule } from 'nestjs-pino';
import { WinstonModule } from 'nest-winston';
import { join } from 'node:path';
import * as winston from 'winston';

@Module({
  imports: [
    /**
     * è¿™éƒ¨åˆ†å­¦ä¹  nestjs-pino æ¨¡å—
     * https://github.com/iamolegga/nestjs-pino
     */
    LoggerModule.forRoot({
      pinoHttp: {
        transport: {
          targets: [
            process.env.NODE_ENV === 'development'
              ? {
                  level: 'info',
                  target: 'pino-pretty',
                  options: {
                    colorize: true, // æ ¼å¼åŒ– æ›´å¥½çœ‹ä¸€äº›
                  },
                }
              : {
                  level: 'info',
                  target: 'pino-roll',
                  // ä¸‹é¢è¿™ä¸ªé…ç½®æ˜¯ç”Ÿäº§ç¯å¢ƒå¯ç”¨æ—¥å¿—å­˜å‚¨çš„ç›¸å…³çš„é…ç½®
                  options: {
                    file: join('logs', 'pino-log.txt'),
                    frequency: 'daily', // æ‰“å°å‘¨æœŸ hourly
                    size: '10m', // å•ä¸ªæ–‡ä»¶å¤§å°ï¼Œ å¦‚æœè¶…å‡ºäº†å°±æ–°å»ºæ–‡ä»¶
                    mkdir: true,
                  },
                },
          ],
        },
      },
    }),

    /**
     * Winston æ—¥å¿—åº“é›†æˆå­¦ä¹ 
     * æä¾›æ›´çµæ´»çš„æ—¥å¿—é…ç½®å’Œå¤šç§ä¼ è¾“æ–¹å¼
     */
    WinstonModule.forRoot({
      level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
      
      // è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
      format: winston.format.combine(
        winston.format.timestamp({
          format: 'YYYY-MM-DD HH:mm:ss',
        }),
        winston.format.errors({ stack: true }),
        winston.format.json(),
        // æ·»åŠ è‡ªå®šä¹‰æ ¼å¼åŒ–
        winston.format.printf(({ level, message, timestamp, stack, ...meta }) => {
          let log = `${timestamp} [${level.toUpperCase()}]: ${message}`;
          if (stack) {
            log += `\n${stack}`;
          }
          if (Object.keys(meta).length > 0) {
            log += `\nMeta: ${JSON.stringify(meta, null, 2)}`;
          }
          return log;
        })
      ),

      // é…ç½®å¤šç§ä¼ è¾“æ–¹å¼
      transports: [
        // æ§åˆ¶å°è¾“å‡ºï¼ˆå¼€å‘ç¯å¢ƒå¯ç”¨å½©è‰²ï¼‰
        new winston.transports.Console({
          format: process.env.NODE_ENV === 'development'
            ? winston.format.combine(
                winston.format.colorize(),
                winston.format.simple()
              )
            : winston.format.json(),
        }),

        // é”™è¯¯æ—¥å¿—æ–‡ä»¶
        new winston.transports.File({
          filename: join('logs', 'winston-error.log'),
          level: 'error',
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
          maxsize: 5242880, // 5MB
          maxFiles: 10,
        }),

        // æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
        new winston.transports.File({
          filename: join('logs', 'winston-combined.log'),
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
          maxsize: 5242880, // 5MB  
          maxFiles: 15,
        }),

        // å¼€å‘ç¯å¢ƒé¢å¤–çš„è°ƒè¯•æ—¥å¿—
        ...(process.env.NODE_ENV === 'development'
          ? [
              new winston.transports.File({
                filename: join('logs', 'winston-debug.log'),
                level: 'debug',
                format: winston.format.combine(
                  winston.format.timestamp(),
                  winston.format.json(),
                  winston.format.prettyPrint()
                ),
              }),
            ]
          : []),
      ],

      // å¤„ç†æœªæ•è·çš„å¼‚å¸¸
      exceptionHandlers: [
        new winston.transports.File({
          filename: join('logs', 'winston-exceptions.log'),
        }),
      ],

      // å¤„ç†æœªæ•è·çš„ Promise æ‹’ç»
      rejectionHandlers: [
        new winston.transports.File({
          filename: join('logs', 'winston-rejections.log'),
        }),
      ],
    }),
  ],
  providers: [LogService],
  controllers: [LogController],
})
export class LogModule {}
```

```typescript
import { Controller, Logger, Get, Inject } from '@nestjs/common';
import { LogService } from './log.service';
import { PinoLogger } from 'nestjs-pino';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { Logger as WinstonLogger } from 'winston';

@Controller('log')
export class LogController {
  private readonly nestLogger = new Logger(LogController.name);

  constructor(
    private readonly logService: LogService,
    private readonly pinoLogger: PinoLogger,
    @Inject(WINSTON_MODULE_PROVIDER) 
    private readonly winstonLogger: WinstonLogger,
  ) {
    this.nestLogger.log('æ—¥å¿—æ¨¡å—é›†æˆæˆåŠŸ');
    this.winstonLogger.info('Winston logger initialized successfully');
  }

  @Get('/')
  testDefaultLogger() {
    this.nestLogger.log('æµ‹è¯• NestJS å†…ç½® Logger');
    return this.logService.hello();
  }

  @Get('/pino')
  testPinoLogger() {
    this.pinoLogger.info('æµ‹è¯• Pino Logger - é«˜æ€§èƒ½æ—¥å¿—åº“');
    this.pinoLogger.debug('Pino debug message', { 
      userId: 12345, 
      action: 'test_pino' 
    });
    return {
      message: 'è¯·æ±‚ nestjs-pino logger æˆåŠŸ',
      performance: 'Pino is extremely fast!',
    };
  }

  @Get('/winston')
  testWinstonLogger() {
    // æµ‹è¯•ä¸åŒçš„æ—¥å¿—çº§åˆ«
    this.winstonLogger.info('æµ‹è¯• Winston Logger - åŠŸèƒ½ä¸°å¯Œçš„æ—¥å¿—åº“');
    this.winstonLogger.debug('Winston debug information', {
      userId: 67890,
      action: 'test_winston',
      metadata: { browser: 'Chrome', ip: '192.168.1.1' }
    });
    this.winstonLogger.warn('è¿™æ˜¯ä¸€ä¸ªè­¦å‘Šæ¶ˆæ¯', { 
      warning: 'Resource usage high' 
    });

    return {
      message: 'è¯·æ±‚ Winston logger æˆåŠŸ',
      features: 'Winston provides rich customization options!',
    };
  }

  @Get('/winston/error')
  testWinstonError() {
    try {
      // æ¨¡æ‹Ÿä¸€ä¸ªé”™è¯¯
      throw new Error('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯');
    } catch (error) {
      // Winston ä¼šè‡ªåŠ¨å¤„ç†é”™è¯¯å †æ ˆè·Ÿè¸ª
      this.winstonLogger.error('æ•è·åˆ°é”™è¯¯', {
        error: error.message,
        stack: error.stack,
        endpoint: '/winston/error',
        timestamp: new Date().toISOString(),
      });
      
      return {
        message: 'é”™è¯¯å·²è®°å½•åˆ° Winston',
        errorLogged: true,
      };
    }
  }

  @Get('/compare')
  compareLoggers() {
    const startTime = Date.now();
    
    // åŒæ—¶ä½¿ç”¨ä¸‰ç§æ—¥å¿—åº“è®°å½•ç›¸åŒä¿¡æ¯
    const logData = {
      userId: 999,
      action: 'compare_loggers',
      timestamp: new Date().toISOString(),
    };

    // NestJS å†…ç½® Logger
    this.nestLogger.log('æ—¥å¿—åº“æ€§èƒ½å¯¹æ¯”æµ‹è¯•', JSON.stringify(logData));
    
    // Pino Logger  
    this.pinoLogger.info('Performance comparison test', logData);
    
    // Winston Logger
    this.winstonLogger.info('Logger performance comparison', logData);

    const endTime = Date.now();
    
    return {
      message: 'ä¸‰ç§æ—¥å¿—åº“å¯¹æ¯”æµ‹è¯•å®Œæˆ',
      executionTime: `${endTime - startTime}ms`,
      loggers: ['NestJS Built-in', 'Pino', 'Winston'],
      recommendation: 'Check logs folder to see different outputs',
    };
  }
}
```

```typescript
import { Injectable, Inject } from '@nestjs/common';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { Logger as WinstonLogger } from 'winston';

@Injectable()
export class LogService {
  constructor(
    @Inject(WINSTON_MODULE_PROVIDER) 
    private readonly winstonLogger: WinstonLogger,
  ) {}

  hello() {
    this.winstonLogger.info('LogService.hello() method called');
    return {
      code: 0,
      data: [],
      msg: 'è¯·æ±‚ logger æˆåŠŸï¼',
    };
  }

  // æ¼”ç¤º Winston åœ¨ä¸šåŠ¡é€»è¾‘ä¸­çš„ä½¿ç”¨
  async simulateUserAction(userId: number, action: string) {
    this.winstonLogger.info('User action started', {
      userId,
      action,
      timestamp: new Date().toISOString(),
    });

    try {
      // æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡é€»è¾‘
      await new Promise(resolve => setTimeout(resolve, 100));
      
      this.winstonLogger.info('User action completed successfully', {
        userId,
        action,
        status: 'success',
        duration: '100ms',
      });

      return {
        code: 0,
        data: { userId, action },
        msg: 'ç”¨æˆ·æ“ä½œå®Œæˆ',
      };
    } catch (error) {
      this.winstonLogger.error('User action failed', {
        userId,
        action,
        error: error.message,
        status: 'failed',
      });

      return {
        code: 1,
        data: null,
        msg: 'ç”¨æˆ·æ“ä½œå¤±è´¥',
      };
    }
  }

  // æ¼”ç¤ºç»“æ„åŒ–æ—¥å¿—è®°å½•
  logBusinessEvent(eventType: string, data: any) {
    this.winstonLogger.info('Business event occurred', {
      eventType,
      data,
      source: 'LogService',
      timestamp: new Date().toISOString(),
    });
  }
}
```

```shellscript
# æµ‹è¯• Winston åŸºæœ¬åŠŸèƒ½
curl http://localhost:3000/log/winston

# æµ‹è¯• Winston é”™è¯¯å¤„ç†
curl http://localhost:3000/log/winston/error

# å¯¹æ¯”ä¸‰ç§æ—¥å¿—åº“
curl http://localhost:3000/log/compare
```

```shellscript
# æŸ¥çœ‹ logs ç›®å½•
ls -la logs/

# æŸ¥çœ‹ Winston ç»¼åˆæ—¥å¿—
cat logs/winston-combined.log

# æŸ¥çœ‹ Winston é”™è¯¯æ—¥å¿—
cat logs/winston-error.log

# å¼€å‘ç¯å¢ƒä¸‹æŸ¥çœ‹è°ƒè¯•æ—¥å¿—
cat logs/winston-debug.log
```

```plaintext
error: 0
warn:
```

---

**User**

@log.module.ts è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ä¸­å…³äºWinstoné…ç½®çš„ä»£ç 

---

**Cursor**

æˆ‘æ¥è¯¦ç»†è§£é‡Šæ‚¨çš„ `log.module.ts` æ–‡ä»¶ä¸­ Winston é…ç½®çš„æ¯ä¸ªéƒ¨åˆ†ï¼š

## Winston é…ç½®è¯¦ç»†è§£æ

### 1. **æ¨¡å—å¯¼å…¥éƒ¨åˆ†**
```typescript
import { WinstonModule } from 'nest-winston';
import * as winston from 'winston';
import 'winston-daily-rotate-file';
```

- `nest-winston`: NestJS çš„ Winston é›†æˆåŒ…
- `winston`: Winston æ ¸å¿ƒåº“
- `winston-daily-rotate-file`: Winston æ’ä»¶ï¼Œç”¨äºæ—¥å¿—æ–‡ä»¶çš„æŒ‰æ—¥æœŸè½®è½¬

### 2. **åŸºç¡€é…ç½®**
```typescript
WinstonModule.forRoot({
  level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
```

**æ—¥å¿—çº§åˆ«è®¾ç½®:**
- **å¼€å‘ç¯å¢ƒ**: `debug` - æ˜¾ç¤ºæ‰€æœ‰çº§åˆ«çš„æ—¥å¿—ï¼ˆerror, warn, info, debugï¼‰
- **ç”Ÿäº§ç¯å¢ƒ**: `info` - åªæ˜¾ç¤º info åŠä»¥ä¸Šçº§åˆ«çš„æ—¥å¿—

**Winston æ—¥å¿—çº§åˆ«ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰:**
```
error: 0    // é”™è¯¯ä¿¡æ¯
warn: 1     // è­¦å‘Šä¿¡æ¯  
info: 2     // ä¸€èˆ¬ä¿¡æ¯
http: 3     // HTTP è¯·æ±‚ä¿¡æ¯
verbose: 4  // è¯¦ç»†ä¿¡æ¯
debug: 5    // è°ƒè¯•ä¿¡æ¯
silly: 6    // æœ€è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
```

### 3. **æ—¥å¿—æ ¼å¼åŒ–é…ç½®**
```typescript
format: winston.format.combine(
  winston.format.timestamp({
    format: 'YYYY-MM-DD HH:mm:ss',
  }),
  winston.format.errors({ stack: true }),
  winston.format.json(),
),
```

**æ ¼å¼åŒ–å™¨ç»„åˆ:**
- `timestamp()`: æ·»åŠ æ—¶é—´æˆ³ï¼Œæ ¼å¼ä¸º `2024-01-20 15:30:45`
- `errors({ stack: true })`: ä¸ºé”™è¯¯å¯¹è±¡æ·»åŠ å®Œæ•´çš„å †æ ˆè·Ÿè¸ªä¿¡æ¯
- `json()`: å°†æ—¥å¿—è¾“å‡ºä¸º JSON æ ¼å¼ï¼Œä¾¿äºæœºå™¨è§£æ

**æ³¨é‡Šæ‰çš„è‡ªå®šä¹‰æ ¼å¼åŒ–å™¨:**
```typescript
// winston.format.printf(({ level, message, timestamp, stack, ...meta }) => {
//   let log = `${timestamp} [${level.toUpperCase()}]: ${message}`;
//   if (stack) {
//     log += `\n${stack}`;
//   }
//   if (Object.keys(meta).length > 0) {
//     log += `\nMeta: ${JSON.stringify(meta, null, 2)}`;
//   }
//   return log;
// }),
```
è¿™ä¸ªè‡ªå®šä¹‰æ ¼å¼åŒ–å™¨å¯ä»¥åˆ›å»ºæ›´äººæ€§åŒ–çš„æ—¥å¿—è¾“å‡ºæ ¼å¼ã€‚

### 4. **ä¼ è¾“æ–¹å¼é…ç½® (Transports)**

#### **æ§åˆ¶å°è¾“å‡º**
```typescript
new winston.transports.Console({
  format: process.env.NODE_ENV === 'development'
    ? winston.format.combine(
        winston.format.colorize(),
        winston.format.simple(),
      )
    : winston.format.json(),
}),
```

- **å¼€å‘ç¯å¢ƒ**: å½©è‰²ç®€å•æ ¼å¼ï¼Œä¾¿äºé˜…è¯»
- **ç”Ÿäº§ç¯å¢ƒ**: JSON æ ¼å¼ï¼Œä¾¿äºæ—¥å¿—æ”¶é›†å·¥å…·å¤„ç†

#### **é”™è¯¯æ—¥å¿—æ–‡ä»¶**
```typescript
new winston.transports.File({
  filename: join('logs', 'winston-error.log'),
  level: 'error',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json(),
  ),
  maxsize: 5242880, // 5MB
  maxFiles: 10,
}),
```

**é…ç½®è¯´æ˜:**
- åªè®°å½• `error` çº§åˆ«çš„æ—¥å¿—
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼š5MB
- æœ€å¤§æ–‡ä»¶æ•°ï¼š10ä¸ªï¼ˆè¶…è¿‡ååˆ é™¤æœ€æ—§çš„ï¼‰
- è·¯å¾„ï¼š`logs/winston-error.log`

#### **ç»¼åˆæ—¥å¿—æ–‡ä»¶**
```typescript
new winston.transports.File({
  filename: join('logs', 'winston-combined.log'),
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json(),
  ),
  maxsize: 5242880, // 5MB
  maxFiles: 15,
}),
```

- è®°å½•æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—
- æœ€å¤§æ–‡ä»¶æ•°ï¼š15ä¸ª

#### **æŒ‰æ—¥æœŸè½®è½¬çš„æ—¥å¿—æ–‡ä»¶**
```typescript
new winston.transports.DailyRotateFile({
  level: 'warn',
  dirname: 'logs',
  filename: 'application-%DATE%.log',
  datePattern: 'YYYY-MM-DD-HH',
  zippedArchive: true,
  maxSize: '20m',
  maxFiles: '14d',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.simple(),
  ),
}),
```

**è¯¦ç»†é…ç½®è§£æ:**
- `level: 'warn'`: åªè®°å½• warn åŠä»¥ä¸Šçº§åˆ«çš„æ—¥å¿—
- `filename: 'application-%DATE%.log'`: æ–‡ä»¶ååŒ…å«æ—¥æœŸ
- `datePattern: 'YYYY-MM-DD-HH'`: æŒ‰å°æ—¶è½®è½¬ï¼ˆæ¯å°æ—¶ç”Ÿæˆæ–°æ–‡ä»¶ï¼‰
- `zippedArchive: true`: æ—§æ–‡ä»¶è‡ªåŠ¨å‹ç¼©ä¸º .gz æ ¼å¼
- `maxSize: '20m'`: å•æ–‡ä»¶æœ€å¤§ 20MB
- `maxFiles: '14d'`: ä¿ç•™ 14 å¤©çš„æ—¥å¿—æ–‡ä»¶

**ç¤ºä¾‹æ–‡ä»¶å:**
```
application-2024-01-20-14.log
application-2024-01-20-15.log.gz (å‹ç¼©çš„æ—§æ–‡ä»¶)
```

#### **ä¿¡æ¯çº§åˆ«çš„è½®è½¬æ—¥å¿—**
```typescript
new winston.transports.DailyRotateFile({
  level: 'info',
  dirname: 'logs',
  filename: 'info-%DATE%.log',
  datePattern: 'YYYY-MM-DD-HH',
  zippedArchive: true,
  maxSize: '20m',
  maxFiles: '14d',
}),
```

ä¸“é—¨è®°å½• `info` çº§åˆ«åŠä»¥ä¸Šçš„æ—¥å¿—ã€‚

#### **å¼€å‘ç¯å¢ƒè°ƒè¯•æ—¥å¿—**
```typescript
...(process.env.NODE_ENV === 'development'
  ? [
      new winston.transports.File({
        filename: join('logs', 'winston-debug.log'),
        level: 'debug',
        format: winston.format.combine(
          winston.format.timestamp(),
          winston.format.json(),
          winston.format.prettyPrint(),
        ),
      }),
    ]
  : []),
```

**æ¡ä»¶æ€§é…ç½®:**
- åªåœ¨å¼€å‘ç¯å¢ƒå¯ç”¨
- ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ `...` æ¡ä»¶æ€§æ·»åŠ åˆ° transports æ•°ç»„
- `prettyPrint()`: ç¾åŒ– JSON è¾“å‡ºï¼Œä¾¿äºé˜…è¯»

### 5. **å¼‚å¸¸å¤„ç†é…ç½®**

#### **æœªæ•è·å¼‚å¸¸å¤„ç†**
```typescript
exceptionHandlers: [
  new winston.transports.File({
    filename: join('logs', 'winston-exceptions.log'),
  }),
],
```

æ•è·å¹¶è®°å½•åº”ç”¨ä¸­æœªè¢« try-catch å¤„ç†çš„å¼‚å¸¸ã€‚

#### **Promise æ‹’ç»å¤„ç†**
```typescript
rejectionHandlers: [
  new winston.transports.File({
    filename: join('logs', 'winston-rejections.log'),
  }),
],
```

æ•è·å¹¶è®°å½•æœªå¤„ç†çš„ Promise æ‹’ç»ï¼ˆunhandled promise rejectionsï¼‰ã€‚

## ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶ç»“æ„

è¿è¡Œåï¼Œæ‚¨çš„ `logs` ç›®å½•å°†åŒ…å«ï¼š

```
logs/
â”œâ”€â”€ winston-error.log              # é”™è¯¯æ—¥å¿—
â”œâ”€â”€ winston-combined.log           # ç»¼åˆæ—¥å¿—
â”œâ”€â”€ winston-debug.log              # è°ƒè¯•æ—¥å¿—ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
â”œâ”€â”€ winston-exceptions.log         # æœªæ•è·å¼‚å¸¸
â”œâ”€â”€ winston-rejections.log         # Promise æ‹’ç»
â”œâ”€â”€ application-2024-01-20-14.log  # æŒ‰å°æ—¶è½®è½¬çš„åº”ç”¨æ—¥å¿—
â”œâ”€â”€ application-2024-01-20-15.log.gz  # å‹ç¼©çš„æ—§æ—¥å¿—
â”œâ”€â”€ info-2024-01-20-14.log         # ä¿¡æ¯çº§åˆ«è½®è½¬æ—¥å¿—
â””â”€â”€ pino-log.txt                   # Pino æ—¥å¿—
```

## ä½¿ç”¨å»ºè®®

1. **å¼€å‘ç¯å¢ƒ**: ä¸»è¦æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºå’Œ `winston-debug.log`
2. **ç”Ÿäº§ç¯å¢ƒ**: é‡ç‚¹å…³æ³¨é”™è¯¯æ—¥å¿—å’Œè½®è½¬æ—¥å¿—
3. **æ€§èƒ½ç›‘æ§**: ä½¿ç”¨ JSON æ ¼å¼ä¾¿äºæ—¥å¿—åˆ†æå·¥å…·å¤„ç†
4. **å­˜å‚¨ç®¡ç†**: è½®è½¬é…ç½®å¯æœ‰æ•ˆæ§åˆ¶ç£ç›˜ç©ºé—´ä½¿ç”¨

è¿™ä¸ªé…ç½®éå¸¸å…¨é¢ï¼Œæ¶µç›–äº† Winston çš„ä¸»è¦åŠŸèƒ½ï¼Œé€‚åˆå­¦ä¹ å’Œç”Ÿäº§ä½¿ç”¨ï¼

```typescript
import { WinstonModule } from 'nest-winston';
import * as winston from 'winston';
import 'winston-daily-rotate-file';
```

```typescript
WinstonModule.forRoot({
  level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
```

```plaintext
error: 0    // é”™è¯¯ä¿¡æ¯
warn: 1     // è­¦å‘Šä¿¡æ¯  
info: 2     // ä¸€èˆ¬ä¿¡æ¯
http: 3     // HTTP è¯·æ±‚ä¿¡æ¯
verbose: 4  // è¯¦ç»†ä¿¡æ¯
debug: 5    // è°ƒè¯•ä¿¡æ¯
silly: 6    // æœ€è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
```

```typescript
format: winston.format.combine(
  winston.format.timestamp({
    format: 'YYYY-MM-DD HH:mm:ss',
  }),
  winston.format.errors({ stack: true }),
  winston.format.json(),
),
```

```typescript
// winston.format.printf(({ level, message, timestamp, stack, ...meta }) => {
//   let log = `${timestamp} [${level.toUpperCase()}]: ${message}`;
//   if (stack) {
//     log += `\n${stack}`;
//   }
//   if (Object.keys(meta).length > 0) {
//     log += `\nMeta: ${JSON.stringify(meta, null, 2)}`;
//   }
//   return log;
// }),
```

```typescript
new winston.transports.Console({
  format: process.env.NODE_ENV === 'development'
    ? winston.format.combine(
        winston.format.colorize(),
        winston.format.simple(),
      )
    : winston.format.json(),
}),
```

```typescript
new winston.transports.File({
  filename: join('logs', 'winston-error.log'),
  level: 'error',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json(),
  ),
  maxsize: 5242880, // 5MB
  maxFiles: 10,
}),
```

```typescript
new winston.transports.File({
  filename: join('logs', 'winston-combined.log'),
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json(),
  ),
  maxsize: 5242880, // 5MB
  maxFiles: 15,
}),
```

```typescript
new winston.transports.DailyRotateFile({
  level: 'warn',
  dirname: 'logs',
  filename: 'application-%DATE%.log',
  datePattern: 'YYYY-MM-DD-HH',
  zippedArchive: true,
  maxSize: '20m',
  maxFiles: '14d',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.simple(),
  ),
}),
```

```plaintext
application-2024-01-20-14.log
application-2024-01-20-15.log.gz (å‹ç¼©çš„æ—§æ–‡ä»¶)
```

```typescript
new winston.transports.DailyRotateFile({
  level: 'info',
  dirname: 'logs',
  filename: 'info-%DATE%.log',
  datePattern: 'YYYY-MM-DD-HH',
  zippedArchive: true,
  maxSize: '20m',
  maxFiles: '14d',
}),
```

```typescript
...(process.env.NODE_ENV === 'development'
  ? [
      new winston.transports.File({
        filename: join('logs', 'winston-debug.log'),
        level: 'debug',
        format: winston.format.combine(
          winston.format.timestamp(),
          winston.format.json(),
          winston.format.prettyPrint(),
        ),
      }),
    ]
  : []),
```

```typescript
exceptionHandlers: [
  new winston.transports.File({
    filename: join('logs', 'winston-exceptions.log'),
  }),
],
```

```typescript
rejectionHandlers: [
  new winston.transports.File({
    filename: join('logs', 'winston-rejections.log'),
  }),
],
```

```plaintext
logs/
â”œâ”€â”€ winston-error.log              # é”™è¯¯æ—¥å¿—
â”œâ”€â”€ winston-combined.log           # ç»¼åˆæ—¥å¿—
â”œâ”€â”€ winston-debug.log              # è°ƒè¯•æ—¥å¿—ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
â”œâ”€â”€ winston-exceptions.log         # æœªæ•è·å¼‚å¸¸
â”œâ”€â”€ winston-rejections.log         # Promise æ‹’ç»
â”œâ”€â”€ application-2024-01-20-14.log  # æŒ‰å°æ—¶è½®è½¬çš„åº”ç”¨æ—¥å¿—
â”œâ”€â”€ application-2024-01-20-15.log.gz  # å‹ç¼©çš„æ—§æ—¥å¿—
â”œâ”€â”€ info-2024-01-20-14.log         # ä¿¡æ¯çº§åˆ«è½®è½¬æ—¥å¿—
â””â”€â”€ pino-log.txt                   # Pino æ—¥å¿—
```

---

**User**

nestä¸­å¦‚ä½•ä½¿ç”¨å¼‚å¸¸è¿‡æ»¤å™¨

---

**Cursor**

æˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†ä»‹ç» NestJS ä¸­å¼‚å¸¸è¿‡æ»¤å™¨çš„ä½¿ç”¨æ–¹æ³•ã€‚

## å¼‚å¸¸è¿‡æ»¤å™¨æ¦‚è¿°

å¼‚å¸¸è¿‡æ»¤å™¨æ˜¯ NestJS ä¸­å¤„ç†åº”ç”¨ç¨‹åºä¸­æœªå¤„ç†å¼‚å¸¸çš„å¼ºå¤§æœºåˆ¶ã€‚å®ƒä»¬å¯ä»¥æ•è·å¼‚å¸¸å¹¶è¿”å›è‡ªå®šä¹‰çš„å“åº”æ ¼å¼ã€‚

## 1. å†…ç½®å¼‚å¸¸è¿‡æ»¤å™¨

NestJS æä¾›äº†å†…ç½®çš„å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¤„ç†å¸¸è§çš„ HTTP å¼‚å¸¸ï¼š

```typescript
import { HttpException, HttpStatus } from '@nestjs/common';

// æŠ›å‡ºåŸºæœ¬å¼‚å¸¸
throw new HttpException('Forbidden', HttpStatus.FORBIDDEN);

// æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸å¯¹è±¡
throw new HttpException({
  status: HttpStatus.FORBIDDEN,
  error: 'This is a custom message',
}, HttpStatus.FORBIDDEN);
```

## 2. åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸è¿‡æ»¤å™¨

### åŸºç¡€å¼‚å¸¸è¿‡æ»¤å™¨

```typescript
// src/filters/http-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, HttpException } from '@nestjs/common';
import { Request, Response } from 'express';

@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();
    const status = exception.getStatus();

    response
      .status(status)
      .json({
        statusCode: status,
        timestamp: new Date().toISOString(),
        path: request.url,
        method: request.method,
        message: exception.message,
      });
  }
}
```

### å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ï¼ˆæ¨èï¼‰

```typescript
// src/filters/global-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, HttpException, HttpStatus, Logger } from '@nestjs/common';
import { Request, Response } from 'express';

@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  private readonly logger = new Logger(GlobalExceptionFilter.name);

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();

    let status = HttpStatus.INTERNAL_SERVER_ERROR;
    let message = 'Internal server error';
    let error = 'Unknown error';

    // å¤„ç† HTTP å¼‚å¸¸
    if (exception instanceof HttpException) {
      status = exception.getStatus();
      const errorResponse = exception.getResponse();
      
      if (typeof errorResponse === 'string') {
        message = errorResponse;
      } else if (typeof errorResponse === 'object' && errorResponse !== null) {
        message = (errorResponse as any).message || exception.message;
        error = (errorResponse as any).error || 'HttpException';
      }
    } else if (exception instanceof Error) {
      // å¤„ç†å…¶ä»–ç±»å‹çš„é”™è¯¯
      message = exception.message;
      error = exception.name;
    }

    // è®°å½•é”™è¯¯æ—¥å¿—
    this.logger.error(
      `HTTP ${status} Error: ${message}`,
      {
        path: request.url,
        method: request.method,
        userAgent: request.headers['user-agent'],
        ip: request.ip,
        timestamp: new Date().toISOString(),
        stack: exception instanceof Error ? exception.stack : undefined,
      }
    );

    // è¿”å›ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
    const errorResponse = {
      success: false,
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      method: request.method,
      message: message,
      error: error,
      // å¼€å‘ç¯å¢ƒä¸‹è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
      ...(process.env.NODE_ENV === 'development' && {
        stack: exception instanceof Error ? exception.stack : undefined,
      }),
    };

    response.status(status).json(errorResponse);
  }
}
```

## 3. é’ˆå¯¹ç‰¹å®šå¼‚å¸¸ç±»å‹çš„è¿‡æ»¤å™¨

### éªŒè¯å¼‚å¸¸è¿‡æ»¤å™¨

```typescript
// src/filters/validation-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, BadRequestException } from '@nestjs/common';
import { ValidationError } from 'class-validator';
import { Response } from 'express';

@Catch(BadRequestException)
export class ValidationExceptionFilter implements ExceptionFilter {
  catch(exception: BadRequestException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const status = exception.getStatus();
    const exceptionResponse = exception.getResponse() as any;

    // å¤„ç†éªŒè¯é”™è¯¯
    let validationErrors = {};
    if (exceptionResponse.message && Array.isArray(exceptionResponse.message)) {
      validationErrors = this.formatValidationErrors(exceptionResponse.message);
    }

    response.status(status).json({
      success: false,
      statusCode: status,
      timestamp: new Date().toISOString(),
      message: 'Validation failed',
      errors: validationErrors,
    });
  }

  private formatValidationErrors(errors: string[]): Record<string, string[]> {
    const formattedErrors: Record<string, string[]> = {};
    
    errors.forEach(error => {
      // è§£æéªŒè¯é”™è¯¯æ¶ˆæ¯ï¼Œæå–å­—æ®µåå’Œé”™è¯¯ä¿¡æ¯
      const match = error.match(/^(\w+)\s(.+)$/);
      if (match) {
        const [, field, message] = match;
        if (!formattedErrors[field]) {
          formattedErrors[field] = [];
        }
        formattedErrors[field].push(message);
      }
    });

    return formattedErrors;
  }
}
```

### ä¸šåŠ¡å¼‚å¸¸è¿‡æ»¤å™¨

```typescript
// src/filters/business-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, Logger } from '@nestjs/common';
import { Response } from 'express';

// è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸ç±»
export class BusinessException extends Error {
  constructor(
    public readonly code: string,
    public readonly message: string,
    public readonly statusCode: number = 400,
    public readonly data?: any
  ) {
    super(message);
    this.name = 'BusinessException';
  }
}

@Catch(BusinessException)
export class BusinessExceptionFilter implements ExceptionFilter {
  private readonly logger = new Logger(BusinessExceptionFilter.name);

  catch(exception: BusinessException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest();

    // è®°å½•ä¸šåŠ¡å¼‚å¸¸
    this.logger.warn(
      `Business Exception: ${exception.code} - ${exception.message}`,
      {
        path: request.url,
        method: request.method,
        code: exception.code,
        data: exception.data,
      }
    );

    response.status(exception.statusCode).json({
      success: false,
      code: exception.code,
      message: exception.message,
      timestamp: new Date().toISOString(),
      data: exception.data,
    });
  }
}
```

## 4. åœ¨ LogModule ä¸­é›†æˆå¼‚å¸¸è¿‡æ»¤å™¨

### æ›´æ–° `log.controller.ts`

```typescript
// src/log/log.controller.ts
import { Controller, Logger, Get, Post, Body, UseFilters, HttpException, HttpStatus, BadRequestException } from '@nestjs/common';
import { LogService } from './log.service';
import { PinoLogger } from 'nestjs-pino';
import { HttpExceptionFilter } from '../filters/http-exception.filter';
import { BusinessException, BusinessExceptionFilter } from '../filters/business-exception.filter';
import { ValidationExceptionFilter } from '../filters/validation-exception.filter';

@Controller('log')
@UseFilters(HttpExceptionFilter, BusinessExceptionFilter, ValidationExceptionFilter)
export class LogController {
  private readonly nestLogger = new Logger(LogController.name);

  constructor(
    private readonly logService: LogService,
    private readonly pinoLogger: PinoLogger,
  ) {
    this.nestLogger.log('æ—¥å¿—æ¨¡å—é›†æˆæˆåŠŸ');
  }

  // ... å…¶ä»–ç°æœ‰æ–¹æ³• ...

  @Get('/exception/http')
  testHttpException() {
    // æŠ›å‡ºæ ‡å‡† HTTP å¼‚å¸¸
    throw new HttpException('This is a test HTTP exception', HttpStatus.BAD_REQUEST);
  }

  @Get('/exception/business')
  testBusinessException() {
    // æŠ›å‡ºè‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸
    throw new BusinessException(
      'USER_NOT_FOUND',
      'User with specified ID does not exist',
      404,
      { userId: 12345 }
    );
  }

  @Get('/exception/validation')
  testValidationException() {
    // æŠ›å‡ºéªŒè¯å¼‚å¸¸
    throw new BadRequestException([
      'email must be a valid email',
      'password must be longer than 8 characters',
      'name should not be empty'
    ]);
  }

  @Get('/exception/unexpected')
  testUnexpectedException() {
    // æŠ›å‡ºæ„å¤–å¼‚å¸¸
    throw new Error('This is an unexpected error');
  }

  @Post('/exception/async')
  async testAsyncException(@Body() body: any) {
    try {
      // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œä¸­çš„å¼‚å¸¸
      await this.logService.simulateAsyncError(body.shouldFail);
      return { message: 'Async operation successful' };
    } catch (error) {
      // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè®©è¿‡æ»¤å™¨å¤„ç†
      throw error;
    }
  }
}
```

### æ›´æ–° `log.service.ts`

```typescript
// src/log/log.service.ts
import { Injectable, Logger } from '@nestjs/common';
import { BusinessException } from '../filters/business-exception.filter';

@Injectable()
export class LogService {
  private readonly logger = new Logger(LogService.name);

  // ... å…¶ä»–ç°æœ‰æ–¹æ³• ...

  async simulateAsyncError(shouldFail: boolean) {
    this.logger.log('Starting async operation...');
    
    // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if (shouldFail) {
      throw new BusinessException(
        'ASYNC_OPERATION_FAILED',
        'The async operation failed due to external service unavailability',
        503,
        { service: 'external-api', timestamp: new Date().toISOString() }
      );
    }
    
    this.logger.log('Async operation completed successfully');
    return { success: true };
  }
}
```

## 5. åº”ç”¨å¼‚å¸¸è¿‡æ»¤å™¨

### æ–¹æ³•çº§åº”ç”¨

```typescript
@Get('/test')
@UseFilters(HttpExceptionFilter)
getTest() {
  // æ–¹æ³•é€»è¾‘
}
```

### æ§åˆ¶å™¨çº§åº”ç”¨

```typescript
@Controller('log')
@UseFilters(HttpExceptionFilter, BusinessExceptionFilter)
export class LogController {
  // æ§åˆ¶å™¨é€»è¾‘
}
```

### å…¨å±€åº”ç”¨

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { GlobalExceptionFilter } from './filters/global-exception.filter';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // åº”ç”¨å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
  app.useGlobalFilters(new GlobalExceptionFilter());
  
  await app.listen(3000);
}
bootstrap();
```

### åœ¨æ¨¡å—ä¸­æ³¨å†Œå…¨å±€è¿‡æ»¤å™¨

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from './filters/global-exception.filter';

@Module({
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class AppModule {}
```

## 6. æµ‹è¯•å¼‚å¸¸è¿‡æ»¤å™¨

```bash
# æµ‹è¯•ä¸åŒç±»å‹çš„å¼‚å¸¸
curl http://localhost:3000/log/exception/http
curl http://localhost:3000/log/exception/business
curl http://localhost:3000/log/exception/validation
curl http://localhost:3000/log/exception/unexpected

# æµ‹è¯•å¼‚æ­¥å¼‚å¸¸
curl -X POST http://localhost:3000/log/exception/async \
  -H "Content-Type: application/json" \
  -d '{"shouldFail": true}'
```

## æœ€ä½³å®è·µ

1. **ä½¿ç”¨å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨**ï¼šç»Ÿä¸€å¤„ç†æ‰€æœ‰æœªæ•è·çš„å¼‚å¸¸
2. **æ—¥å¿—è®°å½•**ï¼šåœ¨å¼‚å¸¸è¿‡æ»¤å™¨ä¸­è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
3. **ç¯å¢ƒåŒºåˆ†**ï¼šç”Ÿäº§ç¯å¢ƒä¸è¿”å›æ•æ„Ÿçš„é”™è¯¯ä¿¡æ¯
4. **ç»Ÿä¸€å“åº”æ ¼å¼**ï¼šä¿æŒ API å“åº”æ ¼å¼çš„ä¸€è‡´æ€§
5. **åˆ†ç±»å¤„ç†**ï¼šä¸ºä¸åŒç±»å‹çš„å¼‚å¸¸åˆ›å»ºä¸“é—¨çš„è¿‡æ»¤å™¨

è¿™æ ·çš„å¼‚å¸¸è¿‡æ»¤å™¨è®¾è®¡å¯ä»¥è®©æ‚¨çš„åº”ç”¨æ›´åŠ å¥å£®ï¼Œå¹¶æä¾›æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œè°ƒè¯•ä½“éªŒï¼

```typescript
import { HttpException, HttpStatus } from '@nestjs/common';

// æŠ›å‡ºåŸºæœ¬å¼‚å¸¸
throw new HttpException('Forbidden', HttpStatus.FORBIDDEN);

// æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸å¯¹è±¡
throw new HttpException({
  status: HttpStatus.FORBIDDEN,
  error: 'This is a custom message',
}, HttpStatus.FORBIDDEN);
```

```typescript
// src/filters/http-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, HttpException } from '@nestjs/common';
import { Request, Response } from 'express';

@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();
    const status = exception.getStatus();

    response
      .status(status)
      .json({
        statusCode: status,
        timestamp: new Date().toISOString(),
        path: request.url,
        method: request.method,
        message: exception.message,
      });
  }
}
```

```typescript
// src/filters/global-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, HttpException, HttpStatus, Logger } from '@nestjs/common';
import { Request, Response } from 'express';

@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  private readonly logger = new Logger(GlobalExceptionFilter.name);

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();

    let status = HttpStatus.INTERNAL_SERVER_ERROR;
    let message = 'Internal server error';
    let error = 'Unknown error';

    // å¤„ç† HTTP å¼‚å¸¸
    if (exception instanceof HttpException) {
      status = exception.getStatus();
      const errorResponse = exception.getResponse();
      
      if (typeof errorResponse === 'string') {
        message = errorResponse;
      } else if (typeof errorResponse === 'object' && errorResponse !== null) {
        message = (errorResponse as any).message || exception.message;
        error = (errorResponse as any).error || 'HttpException';
      }
    } else if (exception instanceof Error) {
      // å¤„ç†å…¶ä»–ç±»å‹çš„é”™è¯¯
      message = exception.message;
      error = exception.name;
    }

    // è®°å½•é”™è¯¯æ—¥å¿—
    this.logger.error(
      `HTTP ${status} Error: ${message}`,
      {
        path: request.url,
        method: request.method,
        userAgent: request.headers['user-agent'],
        ip: request.ip,
        timestamp: new Date().toISOString(),
        stack: exception instanceof Error ? exception.stack : undefined,
      }
    );

    // è¿”å›ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
    const errorResponse = {
      success: false,
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      method: request.method,
      message: message,
      error: error,
      // å¼€å‘ç¯å¢ƒä¸‹è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
      ...(process.env.NODE_ENV === 'development' && {
        stack: exception instanceof Error ? exception.stack : undefined,
      }),
    };

    response.status(status).json(errorResponse);
  }
}
```

```typescript
// src/filters/validation-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, BadRequestException } from '@nestjs/common';
import { ValidationError } from 'class-validator';
import { Response } from 'express';

@Catch(BadRequestException)
export class ValidationExceptionFilter implements ExceptionFilter {
  catch(exception: BadRequestException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const status = exception.getStatus();
    const exceptionResponse = exception.getResponse() as any;

    // å¤„ç†éªŒè¯é”™è¯¯
    let validationErrors = {};
    if (exceptionResponse.message && Array.isArray(exceptionResponse.message)) {
      validationErrors = this.formatValidationErrors(exceptionResponse.message);
    }

    response.status(status).json({
      success: false,
      statusCode: status,
      timestamp: new Date().toISOString(),
      message: 'Validation failed',
      errors: validationErrors,
    });
  }

  private formatValidationErrors(errors: string[]): Record<string, string[]> {
    const formattedErrors: Record<string, string[]> = {};
    
    errors.forEach(error => {
      // è§£æéªŒè¯é”™è¯¯æ¶ˆæ¯ï¼Œæå–å­—æ®µåå’Œé”™è¯¯ä¿¡æ¯
      const match = error.match(/^(\w+)\s(.+)$/);
      if (match) {
        const [, field, message] = match;
        if (!formattedErrors[field]) {
          formattedErrors[field] = [];
        }
        formattedErrors[field].push(message);
      }
    });

    return formattedErrors;
  }
}
```

```typescript
// src/filters/business-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, Logger } from '@nestjs/common';
import { Response } from 'express';

// è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸ç±»
export class BusinessException extends Error {
  constructor(
    public readonly code: string,
    public readonly message: string,
    public readonly statusCode: number = 400,
    public readonly data?: any
  ) {
    super(message);
    this.name = 'BusinessException';
  }
}

@Catch(BusinessException)
export class BusinessExceptionFilter implements ExceptionFilter {
  private readonly logger = new Logger(BusinessExceptionFilter.name);

  catch(exception: BusinessException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest();

    // è®°å½•ä¸šåŠ¡å¼‚å¸¸
    this.logger.warn(
      `Business Exception: ${exception.code} - ${exception.message}`,
      {
        path: request.url,
        method: request.method,
        code: exception.code,
        data: exception.data,
      }
    );

    response.status(exception.statusCode).json({
      success: false,
      code: exception.code,
      message: exception.message,
      timestamp: new Date().toISOString(),
      data: exception.data,
    });
  }
}
```

```typescript
// src/log/log.controller.ts
import { Controller, Logger, Get, Post, Body, UseFilters, HttpException, HttpStatus, BadRequestException } from '@nestjs/common';
import { LogService } from './log.service';
import { PinoLogger } from 'nestjs-pino';
import { HttpExceptionFilter } from '../filters/http-exception.filter';
import { BusinessException, BusinessExceptionFilter } from '../filters/business-exception.filter';
import { ValidationExceptionFilter } from '../filters/validation-exception.filter';

@Controller('log')
@UseFilters(HttpExceptionFilter, BusinessExceptionFilter, ValidationExceptionFilter)
export class LogController {
  private readonly nestLogger = new Logger(LogController.name);

  constructor(
    private readonly logService: LogService,
    private readonly pinoLogger: PinoLogger,
  ) {
    this.nestLogger.log('æ—¥å¿—æ¨¡å—é›†æˆæˆåŠŸ');
  }

  // ... å…¶ä»–ç°æœ‰æ–¹æ³• ...

  @Get('/exception/http')
  testHttpException() {
    // æŠ›å‡ºæ ‡å‡† HTTP å¼‚å¸¸
    throw new HttpException('This is a test HTTP exception', HttpStatus.BAD_REQUEST);
  }

  @Get('/exception/business')
  testBusinessException() {
    // æŠ›å‡ºè‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸
    throw new BusinessException(
      'USER_NOT_FOUND',
      'User with specified ID does not exist',
      404,
      { userId: 12345 }
    );
  }

  @Get('/exception/validation')
  testValidationException() {
    // æŠ›å‡ºéªŒè¯å¼‚å¸¸
    throw new BadRequestException([
      'email must be a valid email',
      'password must be longer than 8 characters',
      'name should not be empty'
    ]);
  }

  @Get('/exception/unexpected')
  testUnexpectedException() {
    // æŠ›å‡ºæ„å¤–å¼‚å¸¸
    throw new Error('This is an unexpected error');
  }

  @Post('/exception/async')
  async testAsyncException(@Body() body: any) {
    try {
      // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œä¸­çš„å¼‚å¸¸
      await this.logService.simulateAsyncError(body.shouldFail);
      return { message: 'Async operation successful' };
    } catch (error) {
      // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè®©è¿‡æ»¤å™¨å¤„ç†
      throw error;
    }
  }
}
```

```typescript
// src/log/log.service.ts
import { Injectable, Logger } from '@nestjs/common';
import { BusinessException } from '../filters/business-exception.filter';

@Injectable()
export class LogService {
  private readonly logger = new Logger(LogService.name);

  // ... å…¶ä»–ç°æœ‰æ–¹æ³• ...

  async simulateAsyncError(shouldFail: boolean) {
    this.logger.log('Starting async operation...');
    
    // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if (shouldFail) {
      throw new BusinessException(
        'ASYNC_OPERATION_FAILED',
        'The async operation failed due to external service unavailability',
        503,
        { service: 'external-api', timestamp: new Date().toISOString() }
      );
    }
    
    this.logger.log('Async operation completed successfully');
    return { success: true };
  }
}
```

```typescript
@Get('/test')
@UseFilters(HttpExceptionFilter)
getTest() {
  // æ–¹æ³•é€»è¾‘
}
```

```typescript
@Controller('log')
@UseFilters(HttpExceptionFilter, BusinessExceptionFilter)
export class LogController {
  // æ§åˆ¶å™¨é€»è¾‘
}
```

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { GlobalExceptionFilter } from './filters/global-exception.filter';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // åº”ç”¨å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
  app.useGlobalFilters(new GlobalExceptionFilter());
  
  await app.listen(3000);
}
bootstrap();
```

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from './filters/global-exception.filter';

@Module({
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class AppModule {}
```

```shellscript
# æµ‹è¯•ä¸åŒç±»å‹çš„å¼‚å¸¸
curl http://localhost:3000/log/exception/http
curl http://localhost:3000/log/exception/business
curl http://localhost:3000/log/exception/validation
curl http://localhost:3000/log/exception/unexpected

# æµ‹è¯•å¼‚æ­¥å¼‚å¸¸
curl -X POST http://localhost:3000/log/exception/async \
  -H "Content-Type: application/json" \
  -d '{"shouldFail": true}'
```

---

**User**

å¦‚ä½•æ³¨å†Œå’Œä½¿ç”¨å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ï¼Ÿã€‚å¦å¤–ï¼Œå…¨å±€åº”ç”¨ä¹‹åï¼Œè¿˜éœ€è¦åœ¨æ¨¡å—ä¸­æ³¨å†Œå…¨å±€è¿‡æ»¤å™¨å—

---

**Cursor**

æˆ‘æ¥è¯¦ç»†è§£é‡Šå…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨çš„æ³¨å†Œå’Œä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠå›ç­”æ‚¨å…³äºæ˜¯å¦éœ€è¦é‡å¤æ³¨å†Œçš„é—®é¢˜ã€‚

## å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨çš„æ³¨å†Œæ–¹å¼

### 1. åœ¨ `main.ts` ä¸­æ³¨å†Œï¼ˆæ‚¨å½“å‰ä½¿ç”¨çš„æ–¹å¼ï¼‰

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { GlobalExceptionFilter } from './filters/global-exception.filter';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // æ–¹å¼1: ç›´æ¥å®ä¾‹åŒ–æ³¨å†Œ
  app.useGlobalFilters(new GlobalExceptionFilter());
  
  await app.listen(3000);
}
bootstrap();
```

**ç‰¹ç‚¹ï¼š**
- âœ… ç®€å•ç›´æ¥ï¼Œç«‹å³ç”Ÿæ•ˆ
- âŒ **æ— æ³•ä½¿ç”¨ä¾èµ–æ³¨å…¥**ï¼ˆæ— æ³•æ³¨å…¥ Loggerã€Service ç­‰ï¼‰
- âŒ è¿‡æ»¤å™¨å®ä¾‹ä¸å— NestJS å®¹å™¨ç®¡ç†

### 2. åœ¨æ¨¡å—ä¸­æ³¨å†Œä¸ºå…¨å±€è¿‡æ»¤å™¨ï¼ˆæ¨èï¼‰

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from './filters/global-exception.filter';

@Module({
  imports: [
    // ... å…¶ä»–æ¨¡å—
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class AppModule {}
```

**ç‰¹ç‚¹ï¼š**
- âœ… **æ”¯æŒä¾èµ–æ³¨å…¥**
- âœ… è¿‡æ»¤å™¨å®ä¾‹ç”± NestJS å®¹å™¨ç®¡ç†
- âœ… å¯ä»¥æ³¨å…¥å…¶ä»–æœåŠ¡ï¼ˆLoggerã€ConfigService ç­‰ï¼‰
- âœ… ç¬¦åˆ NestJS æ¶æ„è®¾è®¡åŸåˆ™

### 3. æ”¯æŒä¾èµ–æ³¨å…¥çš„å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨

```typescript
// src/filters/global-exception.filter.ts
import { 
  ExceptionFilter, 
  Catch, 
  ArgumentsHost, 
  HttpException, 
  HttpStatus, 
  Injectable,
  Inject
} from '@nestjs/common';
import { Request, Response } from 'express';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { Logger as WinstonLogger } from 'winston';
import { ConfigService } from '@nestjs/config';

@Injectable()
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  constructor(
    @Inject(WINSTON_MODULE_PROVIDER) 
    private readonly logger: WinstonLogger,
    private readonly configService: ConfigService,
  ) {}

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();

    let status = HttpStatus.INTERNAL_SERVER_ERROR;
    let message = 'Internal server error';
    let error = 'Unknown error';

    // å¤„ç†ä¸åŒç±»å‹çš„å¼‚å¸¸
    if (exception instanceof HttpException) {
      status = exception.getStatus();
      const errorResponse = exception.getResponse();
      
      if (typeof errorResponse === 'string') {
        message = errorResponse;
      } else if (typeof errorResponse === 'object' && errorResponse !== null) {
        message = (errorResponse as any).message || exception.message;
        error = (errorResponse as any).error || 'HttpException';
      }
    } else if (exception instanceof Error) {
      message = exception.message;
      error = exception.name;
    }

    // ä½¿ç”¨æ³¨å…¥çš„ Winston Logger è®°å½•é”™è¯¯
    this.logger.error('Global Exception Caught', {
      path: request.url,
      method: request.method,
      statusCode: status,
      message: message,
      error: error,
      userAgent: request.headers['user-agent'],
      ip: request.ip,
      timestamp: new Date().toISOString(),
      stack: exception instanceof Error ? exception.stack : undefined,
    });

    // æ ¹æ®é…ç½®å†³å®šæ˜¯å¦è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
    const isDevelopment = this.configService.get('NODE_ENV') === 'development';
    
    const errorResponse = {
      success: false,
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      method: request.method,
      message: message,
      error: error,
      // åªåœ¨å¼€å‘ç¯å¢ƒè¿”å›å †æ ˆä¿¡æ¯
      ...(isDevelopment && {
        stack: exception instanceof Error ? exception.stack : undefined,
      }),
    };

    response.status(status).json(errorResponse);
  }
}
```

## å›ç­”æ‚¨çš„é—®é¢˜ï¼šå…¨å±€åº”ç”¨åæ˜¯å¦è¿˜éœ€è¦åœ¨æ¨¡å—ä¸­æ³¨å†Œï¼Ÿ

**ç­”æ¡ˆï¼šä¸éœ€è¦ï¼Œè€Œä¸”ä¸åº”è¯¥é‡å¤æ³¨å†Œï¼**

### é‡å¤æ³¨å†Œçš„é—®é¢˜

å¦‚æœæ‚¨åŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼æ³¨å†Œï¼š

```typescript
// âŒ é”™è¯¯åšæ³•ï¼šåŒæ—¶åœ¨ main.ts å’Œ app.module.ts ä¸­æ³¨å†Œ
// main.ts
app.useGlobalFilters(new GlobalExceptionFilter());

// app.module.ts  
{
  provide: APP_FILTER,
  useClass: GlobalExceptionFilter,
}
```

**ä¼šå¯¼è‡´ï¼š**
- å¼‚å¸¸è¿‡æ»¤å™¨è¢«æ‰§è¡Œä¸¤æ¬¡
- å¯èƒ½å‡ºç°é‡å¤çš„é”™è¯¯å“åº”
- æ€§èƒ½æµªè´¹å’Œæ½œåœ¨çš„å†²çª

### æ¨èçš„æœ€ä½³å®è·µ

#### é€‰æ‹©æ–¹æ¡ˆä¸€ï¼šä»…åœ¨ `app.module.ts` ä¸­æ³¨å†Œï¼ˆæ¨èï¼‰

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { ConfigModule } from '@nestjs/config';
import { GlobalExceptionFilter } from './filters/global-exception.filter';
import { LogModule } from './log/log.module';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
    }),
    LogModule,
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class AppModule {}
```

```typescript
// src/main.ts - æ— éœ€æ³¨å†Œå¼‚å¸¸è¿‡æ»¤å™¨
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { ValidationPipe } from '@nestjs/common';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // åªé…ç½®å…¶ä»–å…¨å±€è®¾ç½®
  app.useGlobalPipes(new ValidationPipe({
    whitelist: true,
    forbidNonWhitelisted: true,
    transform: true,
  }));
  
  await app.listen(3000);
}
bootstrap();
```

#### é€‰æ‹©æ–¹æ¡ˆäºŒï¼šä»…åœ¨ `main.ts` ä¸­æ³¨å†Œï¼ˆå¦‚æœä¸éœ€è¦ä¾èµ–æ³¨å…¥ï¼‰

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { GlobalExceptionFilter } from './filters/global-exception.filter';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  app.useGlobalFilters(new GlobalExceptionFilter());
  
  await app.listen(3000);
}
bootstrap();
```

```typescript
// src/app.module.ts - æ— éœ€æ³¨å†Œå¼‚å¸¸è¿‡æ»¤å™¨
import { Module } from '@nestjs/common';
import { LogModule } from './log/log.module';

@Module({
  imports: [LogModule],
  // ä¸éœ€è¦åœ¨è¿™é‡Œæ³¨å†Œå¼‚å¸¸è¿‡æ»¤å™¨
})
export class AppModule {}
```

## å¦‚ä½•é€‰æ‹©æ³¨å†Œæ–¹å¼ï¼Ÿ

### ä½¿ç”¨ `app.module.ts` æ³¨å†Œçš„åœºæ™¯ï¼š
- âœ… éœ€è¦åœ¨è¿‡æ»¤å™¨ä¸­ä½¿ç”¨ä¾èµ–æ³¨å…¥
- âœ… éœ€è¦æ³¨å…¥ Loggerã€ConfigServiceã€æ•°æ®åº“æœåŠ¡ç­‰
- âœ… æƒ³è¦éµå¾ª NestJS çš„æ¶æ„è®¾è®¡åŸåˆ™
- âœ… éœ€è¦è¿‡æ»¤å™¨å®ä¾‹è¢« NestJS å®¹å™¨ç®¡ç†

### ä½¿ç”¨ `main.ts` æ³¨å†Œçš„åœºæ™¯ï¼š
- âœ… è¿‡æ»¤å™¨é€»è¾‘ç®€å•ï¼Œä¸éœ€è¦ä¾èµ–æ³¨å…¥
- âœ… æƒ³è¦æ›´ç›´æ¥çš„æ§åˆ¶æ–¹å¼
- âœ… å¿«é€ŸåŸå‹å¼€å‘

## æµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨

åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ§åˆ¶å™¨æ¥éªŒè¯å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

```typescript
// src/log/log.controller.ts
@Controller('log')
export class LogController {
  @Get('/test-global-exception')
  testGlobalException() {
    // æŠ›å‡ºå¼‚å¸¸ï¼Œæµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
    throw new HttpException('æµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨', HttpStatus.BAD_REQUEST);
  }

  @Get('/test-unexpected-error')
  testUnexpectedError() {
    // æŠ›å‡ºæ„å¤–é”™è¯¯ï¼Œæµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
    throw new Error('è¿™æ˜¯ä¸€ä¸ªæ„å¤–çš„é”™è¯¯');
  }
}
```

```bash
# æµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
curl http://localhost:3000/log/test-global-exception
curl http://localhost:3000/log/test-unexpected-error
```

## æ€»ç»“

1. **ä¸è¦é‡å¤æ³¨å†Œ**ï¼šé€‰æ‹©ä¸€ç§æ–¹å¼æ³¨å†Œå…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨å³å¯
2. **æ¨èä½¿ç”¨æ¨¡å—æ³¨å†Œ**ï¼šæ”¯æŒä¾èµ–æ³¨å…¥ï¼Œæ›´ç¬¦åˆ NestJS æ¶æ„
3. **ä¾èµ–æ³¨å…¥ä¼˜åŠ¿**ï¼šå¯ä»¥æ³¨å…¥ Loggerã€ConfigService ç­‰æœåŠ¡
4. **ç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼šå…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨æä¾›ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼

é€‰æ‹©é€‚åˆæ‚¨é¡¹ç›®éœ€æ±‚çš„æ³¨å†Œæ–¹å¼ï¼Œå¹¶ç¡®ä¿åªä½¿ç”¨ä¸€ç§æ–¹å¼æ¥é¿å…å†²çªï¼

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { GlobalExceptionFilter } from './filters/global-exception.filter';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // æ–¹å¼1: ç›´æ¥å®ä¾‹åŒ–æ³¨å†Œ
  app.useGlobalFilters(new GlobalExceptionFilter());
  
  await app.listen(3000);
}
bootstrap();
```

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from './filters/global-exception.filter';

@Module({
  imports: [
    // ... å…¶ä»–æ¨¡å—
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class AppModule {}
```

```typescript
// src/filters/global-exception.filter.ts
import { 
  ExceptionFilter, 
  Catch, 
  ArgumentsHost, 
  HttpException, 
  HttpStatus, 
  Injectable,
  Inject
} from '@nestjs/common';
import { Request, Response } from 'express';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { Logger as WinstonLogger } from 'winston';
import { ConfigService } from '@nestjs/config';

@Injectable()
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  constructor(
    @Inject(WINSTON_MODULE_PROVIDER) 
    private readonly logger: WinstonLogger,
    private readonly configService: ConfigService,
  ) {}

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();

    let status = HttpStatus.INTERNAL_SERVER_ERROR;
    let message = 'Internal server error';
    let error = 'Unknown error';

    // å¤„ç†ä¸åŒç±»å‹çš„å¼‚å¸¸
    if (exception instanceof HttpException) {
      status = exception.getStatus();
      const errorResponse = exception.getResponse();
      
      if (typeof errorResponse === 'string') {
        message = errorResponse;
      } else if (typeof errorResponse === 'object' && errorResponse !== null) {
        message = (errorResponse as any).message || exception.message;
        error = (errorResponse as any).error || 'HttpException';
      }
    } else if (exception instanceof Error) {
      message = exception.message;
      error = exception.name;
    }

    // ä½¿ç”¨æ³¨å…¥çš„ Winston Logger è®°å½•é”™è¯¯
    this.logger.error('Global Exception Caught', {
      path: request.url,
      method: request.method,
      statusCode: status,
      message: message,
      error: error,
      userAgent: request.headers['user-agent'],
      ip: request.ip,
      timestamp: new Date().toISOString(),
      stack: exception instanceof Error ? exception.stack : undefined,
    });

    // æ ¹æ®é…ç½®å†³å®šæ˜¯å¦è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
    const isDevelopment = this.configService.get('NODE_ENV') === 'development';
    
    const errorResponse = {
      success: false,
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      method: request.method,
      message: message,
      error: error,
      // åªåœ¨å¼€å‘ç¯å¢ƒè¿”å›å †æ ˆä¿¡æ¯
      ...(isDevelopment && {
        stack: exception instanceof Error ? exception.stack : undefined,
      }),
    };

    response.status(status).json(errorResponse);
  }
}
```

```typescript
// âŒ é”™è¯¯åšæ³•ï¼šåŒæ—¶åœ¨ main.ts å’Œ app.module.ts ä¸­æ³¨å†Œ
// main.ts
app.useGlobalFilters(new GlobalExceptionFilter());

// app.module.ts  
{
  provide: APP_FILTER,
  useClass: GlobalExceptionFilter,
}
```

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { ConfigModule } from '@nestjs/config';
import { GlobalExceptionFilter } from './filters/global-exception.filter';
import { LogModule } from './log/log.module';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
    }),
    LogModule,
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class AppModule {}
```

```typescript
// src/main.ts - æ— éœ€æ³¨å†Œå¼‚å¸¸è¿‡æ»¤å™¨
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { ValidationPipe } from '@nestjs/common';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // åªé…ç½®å…¶ä»–å…¨å±€è®¾ç½®
  app.useGlobalPipes(new ValidationPipe({
    whitelist: true,
    forbidNonWhitelisted: true,
    transform: true,
  }));
  
  await app.listen(3000);
}
bootstrap();
```

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { GlobalExceptionFilter } from './filters/global-exception.filter';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  app.useGlobalFilters(new GlobalExceptionFilter());
  
  await app.listen(3000);
}
bootstrap();
```

```typescript
// src/app.module.ts - æ— éœ€æ³¨å†Œå¼‚å¸¸è¿‡æ»¤å™¨
import { Module } from '@nestjs/common';
import { LogModule } from './log/log.module';

@Module({
  imports: [LogModule],
  // ä¸éœ€è¦åœ¨è¿™é‡Œæ³¨å†Œå¼‚å¸¸è¿‡æ»¤å™¨
})
export class AppModule {}
```

```typescript
// src/log/log.controller.ts
@Controller('log')
export class LogController {
  @Get('/test-global-exception')
  testGlobalException() {
    // æŠ›å‡ºå¼‚å¸¸ï¼Œæµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
    throw new HttpException('æµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨', HttpStatus.BAD_REQUEST);
  }

  @Get('/test-unexpected-error')
  testUnexpectedError() {
    // æŠ›å‡ºæ„å¤–é”™è¯¯ï¼Œæµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
    throw new Error('è¿™æ˜¯ä¸€ä¸ªæ„å¤–çš„é”™è¯¯');
  }
}
```

```shellscript
# æµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
curl http://localhost:3000/log/test-global-exception
curl http://localhost:3000/log/test-unexpected-error
```

---

**User**

åœ¨æ¨¡å—ä¸­æ³¨å†Œå…¨å±€è¿‡æ»¤å™¨ï¼Œæ˜¯å¦éœ€è¦è¿™ä¸ªæ¨¡å—æ˜¯æ ¹æ¨¡å—

---

**Cursor**

è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹å…³äºå…¨å±€è¿‡æ»¤å™¨æ³¨å†Œçš„æ¨¡å—è¦æ±‚ã€‚

## ç®€çŸ­å›ç­”

**ä¸éœ€è¦åœ¨æ ¹æ¨¡å—ä¸­æ³¨å†Œ**ï¼Œä½†**å¼ºçƒˆå»ºè®®åœ¨æ ¹æ¨¡å—ä¸­æ³¨å†Œ**ã€‚

## è¯¦ç»†è§£é‡Š

### 1. æŠ€æœ¯ä¸Šçš„å¯è¡Œæ€§

ä½¿ç”¨ `APP_FILTER` æ³¨å†Œçš„å…¨å±€è¿‡æ»¤å™¨ï¼Œ**æ— è®ºåœ¨å“ªä¸ªæ¨¡å—ä¸­æ³¨å†Œï¼Œéƒ½ä¼šç”Ÿæ•ˆ**ï¼š

```typescript
// src/log/log.module.ts - åœ¨å­æ¨¡å—ä¸­æ³¨å†Œå…¨å±€è¿‡æ»¤å™¨
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from '../filters/global-exception.filter';
import { LogService } from './log.service';
import { LogController } from './log.controller';

@Module({
  providers: [
    LogService,
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter, // è¿™é‡Œæ³¨å†Œçš„å…¨å±€è¿‡æ»¤å™¨ä»ç„¶ä¼šå…¨å±€ç”Ÿæ•ˆ
    },
  ],
  controllers: [LogController],
})
export class LogModule {}
```

```typescript
// src/app.module.ts - æ ¹æ¨¡å—
import { Module } from '@nestjs/common';
import { LogModule } from './log/log.module';

@Module({
  imports: [LogModule], // å¯¼å…¥åŒ…å«å…¨å±€è¿‡æ»¤å™¨çš„å­æ¨¡å—
})
export class AppModule {}
```

**è¿™æ ·é…ç½®åï¼Œ`GlobalExceptionFilter` ä»ç„¶ä¼šåœ¨æ•´ä¸ªåº”ç”¨ä¸­ç”Ÿæ•ˆï¼**

### 2. ä¸ºä»€ä¹ˆå»ºè®®åœ¨æ ¹æ¨¡å—ä¸­æ³¨å†Œï¼Ÿ

#### **æ¶æ„æ¸…æ™°æ€§**
```typescript
// âœ… æ¨èï¼šåœ¨æ ¹æ¨¡å—ä¸­æ³¨å†Œå…¨å±€èµ„æº
// src/app.module.ts
@Module({
  imports: [
    ConfigModule.forRoot({ isGlobal: true }),
    LogModule,
    UserModule,
    OrderModule,
  ],
  providers: [
    // å…¨å±€èµ„æºé›†ä¸­ç®¡ç†
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
    {
      provide: APP_INTERCEPTOR,
      useClass: LoggingInterceptor,
    },
    {
      provide: APP_GUARD,
      useClass: AuthGuard,
    },
  ],
})
export class AppModule {}
```

#### **ä¾èµ–ç®¡ç†æ¸…æ™°**
```typescript
// âŒ ä¸æ¨èï¼šåœ¨å­æ¨¡å—ä¸­æ³¨å†Œå…¨å±€èµ„æº
// src/log/log.module.ts
@Module({
  providers: [
    LogService,
    {
      provide: APP_FILTER, // å…¨å±€è¿‡æ»¤å™¨å´åœ¨ä¸šåŠ¡æ¨¡å—ä¸­
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class LogModule {}
```

**é—®é¢˜ï¼š**
- å…¶ä»–å¼€å‘è€…å¯èƒ½ä¸çŸ¥é“å…¨å±€è¿‡æ»¤å™¨åœ¨å“ªé‡Œæ³¨å†Œ
- å¦‚æœç§»é™¤ `LogModule`ï¼Œå…¨å±€å¼‚å¸¸å¤„ç†å°±å¤±æ•ˆäº†
- è¿åäº†å•ä¸€èŒè´£åŸåˆ™

### 3. å®é™…æµ‹è¯•éªŒè¯

è®©æˆ‘å±•ç¤ºä¸€ä¸ªå®Œæ•´çš„ä¾‹å­æ¥è¯æ˜å­æ¨¡å—ä¸­æ³¨å†Œçš„å…¨å±€è¿‡æ»¤å™¨ç¡®å®ç”Ÿæ•ˆï¼š

```typescript
// src/filters/global-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, Injectable, Logger } from '@nestjs/common';
import { Response } from 'express';

@Injectable()
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  private readonly logger = new Logger(GlobalExceptionFilter.name);

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest();

    this.logger.error(
      `Global Exception Filter triggered from ${this.constructor.name}`,
      {
        path: request.url,
        method: request.method,
        exception: exception instanceof Error ? exception.message : 'Unknown error',
      }
    );

    response.status(500).json({
      message: 'Global Exception Filter Active',
      timestamp: new Date().toISOString(),
      path: request.url,
      registeredIn: 'LogModule', // æ ‡è¯†åœ¨å“ªä¸ªæ¨¡å—æ³¨å†Œ
    });
  }
}
```

```typescript
// src/log/log.module.ts - åœ¨å­æ¨¡å—ä¸­æ³¨å†Œ
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from '../filters/global-exception.filter';
import { LogService } from './log.service';
import { LogController } from './log.controller';

@Module({
  providers: [
    LogService,
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
  controllers: [LogController],
})
export class LogModule {}
```

```typescript
// src/user/user.module.ts - å¦ä¸€ä¸ªä¸šåŠ¡æ¨¡å—
import { Module } from '@nestjs/common';
import { UserController } from './user.controller';

@Module({
  controllers: [UserController],
})
export class UserModule {}
```

```typescript
// src/user/user.controller.ts - æµ‹è¯•å…¨å±€è¿‡æ»¤å™¨æ˜¯å¦ç”Ÿæ•ˆ
import { Controller, Get, HttpException, HttpStatus } from '@nestjs/common';

@Controller('user')
export class UserController {
  @Get('/test-exception')
  testException() {
    // æŠ›å‡ºå¼‚å¸¸ï¼Œæµ‹è¯•åœ¨ LogModule ä¸­æ³¨å†Œçš„å…¨å±€è¿‡æ»¤å™¨æ˜¯å¦ç”Ÿæ•ˆ
    throw new HttpException('Test exception in UserController', HttpStatus.BAD_REQUEST);
  }
}
```

```typescript
// src/app.module.ts - æ ¹æ¨¡å—
import { Module } from '@nestjs/common';
import { LogModule } from './log/log.module';
import { UserModule } from './user/user.module';

@Module({
  imports: [
    LogModule,  // åŒ…å«å…¨å±€è¿‡æ»¤å™¨æ³¨å†Œ
    UserModule, // ä¸åŒ…å«å…¨å±€è¿‡æ»¤å™¨æ³¨å†Œ
  ],
})
export class AppModule {}
```

**æµ‹è¯•ç»“æœï¼š**
```bash
# æµ‹è¯•åœ¨ UserController ä¸­æŠ›å‡ºçš„å¼‚å¸¸
curl http://localhost:3000/user/test-exception

# å“åº”ï¼š
{
  "message": "Global Exception Filter Active",
  "timestamp": "2024-01-20T10:30:00.000Z",
  "path": "/user/test-exception",
  "registeredIn": "LogModule"
}
```

**è¯æ˜ï¼š** åœ¨ `LogModule` ä¸­æ³¨å†Œçš„å…¨å±€è¿‡æ»¤å™¨ç¡®å®åœ¨ `UserController` ä¸­ç”Ÿæ•ˆäº†ï¼

### 4. æœ€ä½³å®è·µå»ºè®®

#### **æ–¹æ¡ˆä¸€ï¼šæ ¹æ¨¡å—æ³¨å†Œï¼ˆæ¨èï¼‰**
```typescript
// src/app.module.ts
@Module({
  imports: [LogModule, UserModule, OrderModule],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class AppModule {}
```

#### **æ–¹æ¡ˆäºŒï¼šä¸“é—¨çš„æ ¸å¿ƒæ¨¡å—**
```typescript
// src/core/core.module.ts
import { Module, Global } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from '../filters/global-exception.filter';

@Global()
@Module({
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class CoreModule {}
```

```typescript
// src/app.module.ts
@Module({
  imports: [
    CoreModule, // æ ¸å¿ƒæ¨¡å—å¤„ç†å…¨å±€èµ„æº
    LogModule,
    UserModule,
  ],
})
export class AppModule {}
```

### 5. éœ€è¦æ³¨æ„çš„ç‚¹

#### **æ¨¡å—åŠ è½½é¡ºåº**
```typescript
// å¦‚æœåœ¨å­æ¨¡å—ä¸­æ³¨å†Œï¼Œç¡®ä¿è¯¥æ¨¡å—è¢«æ­£ç¡®å¯¼å…¥
@Module({
  imports: [
    LogModule, // å¿…é¡»å¯¼å…¥åŒ…å«å…¨å±€è¿‡æ»¤å™¨çš„æ¨¡å—
    UserModule,
  ],
})
export class AppModule {}
```

#### **ä¾èµ–æ³¨å…¥é—®é¢˜**
```typescript
// åœ¨å­æ¨¡å—ä¸­æ³¨å†Œæ—¶ï¼Œç¡®ä¿ä¾èµ–çš„æœåŠ¡åœ¨åŒä¸€æ¨¡å—æˆ–å…¨å±€æ¨¡å—ä¸­
@Module({
  imports: [
    WinstonModule.forRoot({...}), // ç¡®ä¿ Winston åœ¨æ­¤æ¨¡å—ä¸­å¯ç”¨
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter, // å¦‚æœéœ€è¦æ³¨å…¥ Winston
    },
  ],
})
export class LogModule {}
```

## æ€»ç»“

1. **æŠ€æœ¯ä¸Š**ï¼šå¯ä»¥åœ¨ä»»ä½•æ¨¡å—ä¸­æ³¨å†Œå…¨å±€è¿‡æ»¤å™¨
2. **æ¶æ„ä¸Š**ï¼šå»ºè®®åœ¨æ ¹æ¨¡å—æˆ–ä¸“é—¨çš„æ ¸å¿ƒæ¨¡å—ä¸­æ³¨å†Œ
3. **åŸå› **ï¼šä¿æŒæ¶æ„æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤å’Œç†è§£
4. **æ•ˆæœ**ï¼šæ— è®ºåœ¨å“ªä¸ªæ¨¡å—æ³¨å†Œï¼Œå…¨å±€è¿‡æ»¤å™¨éƒ½ä¼šåœ¨æ•´ä¸ªåº”ç”¨ä¸­ç”Ÿæ•ˆ

**å»ºè®®é€‰æ‹©æ ¹æ¨¡å—æ³¨å†Œæ–¹å¼ï¼Œè¿™æ ·æ›´ç¬¦åˆæœ€ä½³å®è·µï¼**

```typescript
// src/log/log.module.ts - åœ¨å­æ¨¡å—ä¸­æ³¨å†Œå…¨å±€è¿‡æ»¤å™¨
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from '../filters/global-exception.filter';
import { LogService } from './log.service';
import { LogController } from './log.controller';

@Module({
  providers: [
    LogService,
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter, // è¿™é‡Œæ³¨å†Œçš„å…¨å±€è¿‡æ»¤å™¨ä»ç„¶ä¼šå…¨å±€ç”Ÿæ•ˆ
    },
  ],
  controllers: [LogController],
})
export class LogModule {}
```

```typescript
// src/app.module.ts - æ ¹æ¨¡å—
import { Module } from '@nestjs/common';
import { LogModule } from './log/log.module';

@Module({
  imports: [LogModule], // å¯¼å…¥åŒ…å«å…¨å±€è¿‡æ»¤å™¨çš„å­æ¨¡å—
})
export class AppModule {}
```

```typescript
// âœ… æ¨èï¼šåœ¨æ ¹æ¨¡å—ä¸­æ³¨å†Œå…¨å±€èµ„æº
// src/app.module.ts
@Module({
  imports: [
    ConfigModule.forRoot({ isGlobal: true }),
    LogModule,
    UserModule,
    OrderModule,
  ],
  providers: [
    // å…¨å±€èµ„æºé›†ä¸­ç®¡ç†
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
    {
      provide: APP_INTERCEPTOR,
      useClass: LoggingInterceptor,
    },
    {
      provide: APP_GUARD,
      useClass: AuthGuard,
    },
  ],
})
export class AppModule {}
```

```typescript
// âŒ ä¸æ¨èï¼šåœ¨å­æ¨¡å—ä¸­æ³¨å†Œå…¨å±€èµ„æº
// src/log/log.module.ts
@Module({
  providers: [
    LogService,
    {
      provide: APP_FILTER, // å…¨å±€è¿‡æ»¤å™¨å´åœ¨ä¸šåŠ¡æ¨¡å—ä¸­
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class LogModule {}
```

```typescript
// src/filters/global-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost, Injectable, Logger } from '@nestjs/common';
import { Response } from 'express';

@Injectable()
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  private readonly logger = new Logger(GlobalExceptionFilter.name);

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest();

    this.logger.error(
      `Global Exception Filter triggered from ${this.constructor.name}`,
      {
        path: request.url,
        method: request.method,
        exception: exception instanceof Error ? exception.message : 'Unknown error',
      }
    );

    response.status(500).json({
      message: 'Global Exception Filter Active',
      timestamp: new Date().toISOString(),
      path: request.url,
      registeredIn: 'LogModule', // æ ‡è¯†åœ¨å“ªä¸ªæ¨¡å—æ³¨å†Œ
    });
  }
}
```

```typescript
// src/log/log.module.ts - åœ¨å­æ¨¡å—ä¸­æ³¨å†Œ
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from '../filters/global-exception.filter';
import { LogService } from './log.service';
import { LogController } from './log.controller';

@Module({
  providers: [
    LogService,
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
  controllers: [LogController],
})
export class LogModule {}
```

```typescript
// src/user/user.module.ts - å¦ä¸€ä¸ªä¸šåŠ¡æ¨¡å—
import { Module } from '@nestjs/common';
import { UserController } from './user.controller';

@Module({
  controllers: [UserController],
})
export class UserModule {}
```

```typescript
// src/user/user.controller.ts - æµ‹è¯•å…¨å±€è¿‡æ»¤å™¨æ˜¯å¦ç”Ÿæ•ˆ
import { Controller, Get, HttpException, HttpStatus } from '@nestjs/common';

@Controller('user')
export class UserController {
  @Get('/test-exception')
  testException() {
    // æŠ›å‡ºå¼‚å¸¸ï¼Œæµ‹è¯•åœ¨ LogModule ä¸­æ³¨å†Œçš„å…¨å±€è¿‡æ»¤å™¨æ˜¯å¦ç”Ÿæ•ˆ
    throw new HttpException('Test exception in UserController', HttpStatus.BAD_REQUEST);
  }
}
```

```typescript
// src/app.module.ts - æ ¹æ¨¡å—
import { Module } from '@nestjs/common';
import { LogModule } from './log/log.module';
import { UserModule } from './user/user.module';

@Module({
  imports: [
    LogModule,  // åŒ…å«å…¨å±€è¿‡æ»¤å™¨æ³¨å†Œ
    UserModule, // ä¸åŒ…å«å…¨å±€è¿‡æ»¤å™¨æ³¨å†Œ
  ],
})
export class AppModule {}
```

```shellscript
# æµ‹è¯•åœ¨ UserController ä¸­æŠ›å‡ºçš„å¼‚å¸¸
curl http://localhost:3000/user/test-exception

# å“åº”ï¼š
{
  "message": "Global Exception Filter Active",
  "timestamp": "2024-01-20T10:30:00.000Z",
  "path": "/user/test-exception",
  "registeredIn": "LogModule"
}
```

```typescript
// src/app.module.ts
@Module({
  imports: [LogModule, UserModule, OrderModule],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class AppModule {}
```

```typescript
// src/core/core.module.ts
import { Module, Global } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from '../filters/global-exception.filter';

@Global()
@Module({
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class CoreModule {}
```

```typescript
// src/app.module.ts
@Module({
  imports: [
    CoreModule, // æ ¸å¿ƒæ¨¡å—å¤„ç†å…¨å±€èµ„æº
    LogModule,
    UserModule,
  ],
})
export class AppModule {}
```

```typescript
// å¦‚æœåœ¨å­æ¨¡å—ä¸­æ³¨å†Œï¼Œç¡®ä¿è¯¥æ¨¡å—è¢«æ­£ç¡®å¯¼å…¥
@Module({
  imports: [
    LogModule, // å¿…é¡»å¯¼å…¥åŒ…å«å…¨å±€è¿‡æ»¤å™¨çš„æ¨¡å—
    UserModule,
  ],
})
export class AppModule {}
```

```typescript
// åœ¨å­æ¨¡å—ä¸­æ³¨å†Œæ—¶ï¼Œç¡®ä¿ä¾èµ–çš„æœåŠ¡åœ¨åŒä¸€æ¨¡å—æˆ–å…¨å±€æ¨¡å—ä¸­
@Module({
  imports: [
    WinstonModule.forRoot({...}), // ç¡®ä¿ Winston åœ¨æ­¤æ¨¡å—ä¸­å¯ç”¨
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter, // å¦‚æœéœ€è¦æ³¨å…¥ Winston
    },
  ],
})
export class LogModule {}
```

---

**User**

@log.module.ts ç›®å‰logæ¨¡å—ä¸­æ³¨å†Œçš„pinoå’ŒWinstonåªèƒ½åœ¨logæ¨¡å—åŠä»¥ä¸‹ä½¿ç”¨å§ã€‚é‚£ç°åœ¨æƒ³è¦åœ¨æ ¹æ¨¡å—ä¸­æ³¨å†Œå…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ï¼Œ å¹¶ä¸”æƒ³æ³¨å…¥pinoå’ŒWinstonã€‚åº”è¯¥æ€ä¹ˆåš

---

**Cursor**

æ‚¨è¯´å¾—å¯¹ï¼å½“å‰ `log.module.ts` ä¸­çš„ Pino å’Œ Winston ç¡®å®åªèƒ½åœ¨ `LogModule` åŠå…¶å­æ¨¡å—ä¸­ä½¿ç”¨ã€‚è¦åœ¨æ ¹æ¨¡å—çš„å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ä¸­æ³¨å…¥å®ƒä»¬ï¼Œæœ‰å‡ ç§è§£å†³æ–¹æ¡ˆï¼š

## æ–¹æ¡ˆä¸€ï¼šå°†æ—¥å¿—é…ç½®ç§»åˆ°æ ¹æ¨¡å—ï¼ˆæ¨èï¼‰

### 1. ä¿®æ”¹ `app.module.ts`

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { LoggerModule } from 'nestjs-pino';
import { WinstonModule } from 'nest-winston';
import * as winston from 'winston';
import 'winston-daily-rotate-file';
import { join } from 'node:path';

import { GlobalExceptionFilter } from './filters/global-exception.filter';
import { LogModule } from './log/log.module';

@Module({
  imports: [
    // å°† Pino é…ç½®ç§»åˆ°æ ¹æ¨¡å—
    LoggerModule.forRoot({
      pinoHttp: {
        transport: {
          targets: [
            process.env.NODE_ENV === 'development'
              ? {
                  level: 'info',
                  target: 'pino-pretty',
                  options: {
                    colorize: true,
                  },
                }
              : {
                  level: 'info',
                  target: 'pino-roll',
                  options: {
                    file: join('logs', 'pino-log.txt'),
                    frequency: 'daily',
                    size: '10m',
                    mkdir: true,
                  },
                },
          ],
        },
      },
    }),

    // å°† Winston é…ç½®ç§»åˆ°æ ¹æ¨¡å—
    WinstonModule.forRoot({
      level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
      format: winston.format.combine(
        winston.format.timestamp({
          format: 'YYYY-MM-DD HH:mm:ss',
        }),
        winston.format.errors({ stack: true }),
        winston.format.json(),
      ),
      transports: [
        new winston.transports.Console({
          format: process.env.NODE_ENV === 'development'
            ? winston.format.combine(
                winston.format.colorize(),
                winston.format.simple()
              )
            : winston.format.json(),
        }),
        new winston.transports.File({
          filename: join('logs', 'winston-error.log'),
          level: 'error',
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
          maxsize: 5242880,
          maxFiles: 10,
        }),
        new winston.transports.File({
          filename: join('logs', 'winston-combined.log'),
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
          maxsize: 5242880,
          maxFiles: 15,
        }),
      ],
    }),

    // å¯¼å…¥ä¸šåŠ¡æ¨¡å—
    LogModule,
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class AppModule {}
```

### 2. ç®€åŒ– `log.module.ts`

```typescript
// src/log/log.module.ts
import { Module } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';

@Module({
  providers: [LogService],
  controllers: [LogController],
})
export class LogModule {}
```

### 3. åˆ›å»ºå…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨

```typescript
// src/filters/global-exception.filter.ts
import { 
  ExceptionFilter, 
  Catch, 
  ArgumentsHost, 
  HttpException, 
  HttpStatus, 
  Injectable,
  Inject
} from '@nestjs/common';
import { Request, Response } from 'express';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { Logger as WinstonLogger } from 'winston';
import { PinoLogger } from 'nestjs-pino';

@Injectable()
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  constructor(
    @Inject(WINSTON_MODULE_PROVIDER) 
    private readonly winstonLogger: WinstonLogger,
    private readonly pinoLogger: PinoLogger,
  ) {}

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();

    let status = HttpStatus.INTERNAL_SERVER_ERROR;
    let message = 'Internal server error';
    let error = 'Unknown error';

    // å¤„ç†ä¸åŒç±»å‹çš„å¼‚å¸¸
    if (exception instanceof HttpException) {
      status = exception.getStatus();
      const errorResponse = exception.getResponse();
      
      if (typeof errorResponse === 'string') {
        message = errorResponse;
      } else if (typeof errorResponse === 'object' && errorResponse !== null) {
        message = (errorResponse as any).message || exception.message;
        error = (errorResponse as any).error || 'HttpException';
      }
    } else if (exception instanceof Error) {
      message = exception.message;
      error = exception.name;
    }

    const errorContext = {
      path: request.url,
      method: request.method,
      statusCode: status,
      message: message,
      error: error,
      userAgent: request.headers['user-agent'],
      ip: request.ip,
      timestamp: new Date().toISOString(),
      stack: exception instanceof Error ? exception.stack : undefined,
    };

    // åŒæ—¶ä½¿ç”¨ Winston å’Œ Pino è®°å½•é”™è¯¯
    this.winstonLogger.error('Global Exception - Winston Logger', errorContext);
    this.pinoLogger.error(errorContext, 'Global Exception - Pino Logger');

    // è¿”å›ç»Ÿä¸€çš„é”™è¯¯å“åº”
    const errorResponse = {
      success: false,
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      method: request.method,
      message: message,
      error: error,
      ...(process.env.NODE_ENV === 'development' && {
        stack: exception instanceof Error ? exception.stack : undefined,
      }),
    };

    response.status(status).json(errorResponse);
  }
}
```

## æ–¹æ¡ˆäºŒï¼šä½¿ç”¨å…¨å±€æ¨¡å—

### 1. è®© LogModule æˆä¸ºå…¨å±€æ¨¡å—

```typescript
// src/log/log.module.ts
import { Module, Global } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';
import { LoggerModule } from 'nestjs-pino';
import { WinstonModule } from 'nest-winston';
import * as winston from 'winston';
import 'winston-daily-rotate-file';
import { join } from 'node:path';

@Global() // ä½¿æ¨¡å—æˆä¸ºå…¨å±€æ¨¡å—
@Module({
  imports: [
    LoggerModule.forRoot({
      pinoHttp: {
        transport: {
          targets: [
            process.env.NODE_ENV === 'development'
              ? {
                  level: 'info',
                  target: 'pino-pretty',
                  options: {
                    colorize: true,
                  },
                }
              : {
                  level: 'info',
                  target: 'pino-roll',
                  options: {
                    file: join('logs', 'pino-log.txt'),
                    frequency: 'daily',
                    size: '10m',
                    mkdir: true,
                  },
                },
          ],
        },
      },
    }),
    WinstonModule.forRoot({
      level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
      format: winston.format.combine(
        winston.format.timestamp({
          format: 'YYYY-MM-DD HH:mm:ss',
        }),
        winston.format.errors({ stack: true }),
        winston.format.json(),
      ),
      transports: [
        // ... Winston é…ç½®
      ],
    }),
  ],
  providers: [LogService],
  controllers: [LogController],
})
export class LogModule {}
```

### 2. æ ¹æ¨¡å—ä¸­æ³¨å†Œå…¨å±€è¿‡æ»¤å™¨

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from './filters/global-exception.filter';
import { LogModule } from './log/log.module';

@Module({
  imports: [
    LogModule, // å…¨å±€æ¨¡å—ï¼Œå…¶ä¸­çš„ providers åœ¨æ•´ä¸ªåº”ç”¨ä¸­å¯ç”¨
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter, // ç°åœ¨å¯ä»¥æ³¨å…¥ Pino å’Œ Winston
    },
  ],
})
export class AppModule {}
```

## æ–¹æ¡ˆä¸‰ï¼šåˆ›å»ºä¸“é—¨çš„æ ¸å¿ƒæ¨¡å—

### 1. åˆ›å»ºæ ¸å¿ƒæ¨¡å—

```typescript
// src/core/core.module.ts
import { Module, Global } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { LoggerModule } from 'nestjs-pino';
import { WinstonModule } from 'nest-winston';
import * as winston from 'winston';
import 'winston-daily-rotate-file';
import { join } from 'node:path';

import { GlobalExceptionFilter } from '../filters/global-exception.filter';

@Global()
@Module({
  imports: [
    // æ—¥å¿—åº“é…ç½®
    LoggerModule.forRoot({
      pinoHttp: {
        transport: {
          targets: [
            process.env.NODE_ENV === 'development'
              ? {
                  level: 'info',
                  target: 'pino-pretty',
                  options: { colorize: true },
                }
              : {
                  level: 'info',
                  target: 'pino-roll',
                  options: {
                    file: join('logs', 'pino-log.txt'),
                    frequency: 'daily',
                    size: '10m',
                    mkdir: true,
                  },
                },
          ],
        },
      },
    }),
    WinstonModule.forRoot({
      level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
      format: winston.format.combine(
        winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
        winston.format.errors({ stack: true }),
        winston.format.json(),
      ),
      transports: [
        new winston.transports.Console({
          format: process.env.NODE_ENV === 'development'
            ? winston.format.combine(
                winston.format.colorize(),
                winston.format.simple()
              )
            : winston.format.json(),
        }),
        new winston.transports.File({
          filename: join('logs', 'winston-error.log'),
          level: 'error',
          maxsize: 5242880,
          maxFiles: 10,
        }),
        new winston.transports.File({
          filename: join('logs', 'winston-combined.log'),
          maxsize: 5242880,
          maxFiles: 15,
        }),
      ],
    }),
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class CoreModule {}
```

### 2. ç®€åŒ–å…¶ä»–æ¨¡å—

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { CoreModule } from './core/core.module';
import { LogModule } from './log/log.module';

@Module({
  imports: [
    CoreModule, // æ ¸å¿ƒæ¨¡å—å¤„ç†å…¨å±€èµ„æº
    LogModule,  // ä¸šåŠ¡æ¨¡å—
  ],
})
export class AppModule {}
```

```typescript
// src/log/log.module.ts - ç®€åŒ–ä¸ºçº¯ä¸šåŠ¡æ¨¡å—
import { Module } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';

@Module({
  providers: [LogService],
  controllers: [LogController],
})
export class LogModule {}
```

## æ¨èæ–¹æ¡ˆ

æˆ‘å»ºè®®ä½¿ç”¨**æ–¹æ¡ˆä¸‰ï¼ˆæ ¸å¿ƒæ¨¡å—ï¼‰**ï¼ŒåŸå› å¦‚ä¸‹ï¼š

1. **èŒè´£åˆ†ç¦»**ï¼šæ ¸å¿ƒæ¨¡å—è´Ÿè´£å…¨å±€èµ„æºï¼Œä¸šåŠ¡æ¨¡å—ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
2. **æ¶æ„æ¸…æ™°**ï¼šå…¨å±€é…ç½®é›†ä¸­ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤
3. **å¤ç”¨æ€§å¥½**ï¼šå…¶ä»–æ¨¡å—å¯ä»¥è½»æ¾ä½¿ç”¨æ—¥å¿—æœåŠ¡
4. **æ‰©å±•æ€§å¼º**ï¼šåç»­å¯ä»¥åœ¨æ ¸å¿ƒæ¨¡å—ä¸­æ·»åŠ å…¶ä»–å…¨å±€æœåŠ¡

## æµ‹è¯•éªŒè¯

```typescript
// src/log/log.controller.ts
import { Controller, Get, HttpException, HttpStatus } from '@nestjs/common';

@Controller('log')
export class LogController {
  @Get('/test-global-filter')
  testGlobalFilter() {
    throw new HttpException('æµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨', HttpStatus.BAD_REQUEST);
  }
}
```

```bash
# æµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
curl http://localhost:3000/log/test-global-filter
```

æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼Œæ‚¨åº”è¯¥èƒ½çœ‹åˆ° Winston å’Œ Pino éƒ½è®°å½•äº†å¼‚å¸¸ä¿¡æ¯ï¼Œè¯æ˜ä¾èµ–æ³¨å…¥æˆåŠŸï¼

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { LoggerModule } from 'nestjs-pino';
import { WinstonModule } from 'nest-winston';
import * as winston from 'winston';
import 'winston-daily-rotate-file';
import { join } from 'node:path';

import { GlobalExceptionFilter } from './filters/global-exception.filter';
import { LogModule } from './log/log.module';

@Module({
  imports: [
    // å°† Pino é…ç½®ç§»åˆ°æ ¹æ¨¡å—
    LoggerModule.forRoot({
      pinoHttp: {
        transport: {
          targets: [
            process.env.NODE_ENV === 'development'
              ? {
                  level: 'info',
                  target: 'pino-pretty',
                  options: {
                    colorize: true,
                  },
                }
              : {
                  level: 'info',
                  target: 'pino-roll',
                  options: {
                    file: join('logs', 'pino-log.txt'),
                    frequency: 'daily',
                    size: '10m',
                    mkdir: true,
                  },
                },
          ],
        },
      },
    }),

    // å°† Winston é…ç½®ç§»åˆ°æ ¹æ¨¡å—
    WinstonModule.forRoot({
      level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
      format: winston.format.combine(
        winston.format.timestamp({
          format: 'YYYY-MM-DD HH:mm:ss',
        }),
        winston.format.errors({ stack: true }),
        winston.format.json(),
      ),
      transports: [
        new winston.transports.Console({
          format: process.env.NODE_ENV === 'development'
            ? winston.format.combine(
                winston.format.colorize(),
                winston.format.simple()
              )
            : winston.format.json(),
        }),
        new winston.transports.File({
          filename: join('logs', 'winston-error.log'),
          level: 'error',
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
          maxsize: 5242880,
          maxFiles: 10,
        }),
        new winston.transports.File({
          filename: join('logs', 'winston-combined.log'),
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
          maxsize: 5242880,
          maxFiles: 15,
        }),
      ],
    }),

    // å¯¼å…¥ä¸šåŠ¡æ¨¡å—
    LogModule,
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class AppModule {}
```

```typescript
// src/log/log.module.ts
import { Module } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';

@Module({
  providers: [LogService],
  controllers: [LogController],
})
export class LogModule {}
```

```typescript
// src/filters/global-exception.filter.ts
import { 
  ExceptionFilter, 
  Catch, 
  ArgumentsHost, 
  HttpException, 
  HttpStatus, 
  Injectable,
  Inject
} from '@nestjs/common';
import { Request, Response } from 'express';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { Logger as WinstonLogger } from 'winston';
import { PinoLogger } from 'nestjs-pino';

@Injectable()
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  constructor(
    @Inject(WINSTON_MODULE_PROVIDER) 
    private readonly winstonLogger: WinstonLogger,
    private readonly pinoLogger: PinoLogger,
  ) {}

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();

    let status = HttpStatus.INTERNAL_SERVER_ERROR;
    let message = 'Internal server error';
    let error = 'Unknown error';

    // å¤„ç†ä¸åŒç±»å‹çš„å¼‚å¸¸
    if (exception instanceof HttpException) {
      status = exception.getStatus();
      const errorResponse = exception.getResponse();
      
      if (typeof errorResponse === 'string') {
        message = errorResponse;
      } else if (typeof errorResponse === 'object' && errorResponse !== null) {
        message = (errorResponse as any).message || exception.message;
        error = (errorResponse as any).error || 'HttpException';
      }
    } else if (exception instanceof Error) {
      message = exception.message;
      error = exception.name;
    }

    const errorContext = {
      path: request.url,
      method: request.method,
      statusCode: status,
      message: message,
      error: error,
      userAgent: request.headers['user-agent'],
      ip: request.ip,
      timestamp: new Date().toISOString(),
      stack: exception instanceof Error ? exception.stack : undefined,
    };

    // åŒæ—¶ä½¿ç”¨ Winston å’Œ Pino è®°å½•é”™è¯¯
    this.winstonLogger.error('Global Exception - Winston Logger', errorContext);
    this.pinoLogger.error(errorContext, 'Global Exception - Pino Logger');

    // è¿”å›ç»Ÿä¸€çš„é”™è¯¯å“åº”
    const errorResponse = {
      success: false,
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      method: request.method,
      message: message,
      error: error,
      ...(process.env.NODE_ENV === 'development' && {
        stack: exception instanceof Error ? exception.stack : undefined,
      }),
    };

    response.status(status).json(errorResponse);
  }
}
```

```typescript
// src/log/log.module.ts
import { Module, Global } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';
import { LoggerModule } from 'nestjs-pino';
import { WinstonModule } from 'nest-winston';
import * as winston from 'winston';
import 'winston-daily-rotate-file';
import { join } from 'node:path';

@Global() // ä½¿æ¨¡å—æˆä¸ºå…¨å±€æ¨¡å—
@Module({
  imports: [
    LoggerModule.forRoot({
      pinoHttp: {
        transport: {
          targets: [
            process.env.NODE_ENV === 'development'
              ? {
                  level: 'info',
                  target: 'pino-pretty',
                  options: {
                    colorize: true,
                  },
                }
              : {
                  level: 'info',
                  target: 'pino-roll',
                  options: {
                    file: join('logs', 'pino-log.txt'),
                    frequency: 'daily',
                    size: '10m',
                    mkdir: true,
                  },
                },
          ],
        },
      },
    }),
    WinstonModule.forRoot({
      level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
      format: winston.format.combine(
        winston.format.timestamp({
          format: 'YYYY-MM-DD HH:mm:ss',
        }),
        winston.format.errors({ stack: true }),
        winston.format.json(),
      ),
      transports: [
        // ... Winston é…ç½®
      ],
    }),
  ],
  providers: [LogService],
  controllers: [LogController],
})
export class LogModule {}
```

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { GlobalExceptionFilter } from './filters/global-exception.filter';
import { LogModule } from './log/log.module';

@Module({
  imports: [
    LogModule, // å…¨å±€æ¨¡å—ï¼Œå…¶ä¸­çš„ providers åœ¨æ•´ä¸ªåº”ç”¨ä¸­å¯ç”¨
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter, // ç°åœ¨å¯ä»¥æ³¨å…¥ Pino å’Œ Winston
    },
  ],
})
export class AppModule {}
```

```typescript
// src/core/core.module.ts
import { Module, Global } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { LoggerModule } from 'nestjs-pino';
import { WinstonModule } from 'nest-winston';
import * as winston from 'winston';
import 'winston-daily-rotate-file';
import { join } from 'node:path';

import { GlobalExceptionFilter } from '../filters/global-exception.filter';

@Global()
@Module({
  imports: [
    // æ—¥å¿—åº“é…ç½®
    LoggerModule.forRoot({
      pinoHttp: {
        transport: {
          targets: [
            process.env.NODE_ENV === 'development'
              ? {
                  level: 'info',
                  target: 'pino-pretty',
                  options: { colorize: true },
                }
              : {
                  level: 'info',
                  target: 'pino-roll',
                  options: {
                    file: join('logs', 'pino-log.txt'),
                    frequency: 'daily',
                    size: '10m',
                    mkdir: true,
                  },
                },
          ],
        },
      },
    }),
    WinstonModule.forRoot({
      level: process.env.NODE_ENV === 'development' ? 'debug' : 'info',
      format: winston.format.combine(
        winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
        winston.format.errors({ stack: true }),
        winston.format.json(),
      ),
      transports: [
        new winston.transports.Console({
          format: process.env.NODE_ENV === 'development'
            ? winston.format.combine(
                winston.format.colorize(),
                winston.format.simple()
              )
            : winston.format.json(),
        }),
        new winston.transports.File({
          filename: join('logs', 'winston-error.log'),
          level: 'error',
          maxsize: 5242880,
          maxFiles: 10,
        }),
        new winston.transports.File({
          filename: join('logs', 'winston-combined.log'),
          maxsize: 5242880,
          maxFiles: 15,
        }),
      ],
    }),
  ],
  providers: [
    {
      provide: APP_FILTER,
      useClass: GlobalExceptionFilter,
    },
  ],
})
export class CoreModule {}
```

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { CoreModule } from './core/core.module';
import { LogModule } from './log/log.module';

@Module({
  imports: [
    CoreModule, // æ ¸å¿ƒæ¨¡å—å¤„ç†å…¨å±€èµ„æº
    LogModule,  // ä¸šåŠ¡æ¨¡å—
  ],
})
export class AppModule {}
```

```typescript
// src/log/log.module.ts - ç®€åŒ–ä¸ºçº¯ä¸šåŠ¡æ¨¡å—
import { Module } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';

@Module({
  providers: [LogService],
  controllers: [LogController],
})
export class LogModule {}
```

```typescript
// src/log/log.controller.ts
import { Controller, Get, HttpException, HttpStatus } from '@nestjs/common';

@Controller('log')
export class LogController {
  @Get('/test-global-filter')
  testGlobalFilter() {
    throw new HttpException('æµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨', HttpStatus.BAD_REQUEST);
  }
}
```

```shellscript
# æµ‹è¯•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
curl http://localhost:3000/log/test-global-filter
```

---

**User**

@exception.controller.ts @log.module.ts logæ¨¡å—ä¸­å·²ç»æ³¨é‡Šäº†globalï¼Œæˆ‘æœŸæœ›åœ¨exceptionæ§åˆ¶å™¨ä¸­ä½¿ç”¨Winstonå’Œpinoåº”è¯¥æŠ¥é”™æ‰å¯¹ï¼Œä¸ºä»€ä¹ˆå¯ä»¥æ­£å¸¸è¿è¡Œ

---

**Cursor**

è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§‚å¯Ÿï¼æ‚¨çš„ç–‘é—®æ˜¯æ­£ç¡®çš„ã€‚è®©æˆ‘æ¥è§£é‡Šä¸ºä»€ä¹ˆå³ä½¿ `LogModule` æ²¡æœ‰ `@Global()` è£…é¥°å™¨ï¼Œ`ExceptionController` ä»ç„¶å¯ä»¥æ³¨å…¥ Winston å’Œ Pinoã€‚

## åŸå› åˆ†æ

### 1. **`forRoot()` æ–¹æ³•çš„ç‰¹æ®Šæ€§**

`WinstonModule.forRoot()` å’Œ `LoggerModule.forRoot()` è¿™äº›æ–¹æ³•ä¼š**è‡ªåŠ¨åˆ›å»ºå…¨å±€æä¾›è€…**ï¼Œå³ä½¿æ‰€åœ¨çš„æ¨¡å—ä¸æ˜¯å…¨å±€æ¨¡å—ï¼š

```typescript
// nest-winston åº“å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ï¼‰
export class WinstonModule {
  static forRoot(options: WinstonModuleOptions): DynamicModule {
    return {
      module: WinstonModule,
      providers: [
        {
          provide: WINSTON_MODULE_PROVIDER,
          useFactory: () => winston.createLogger(options),
          scope: Scope.DEFAULT, // é»˜è®¤ä½œç”¨åŸŸï¼Œå®é™…ä¸Šä¼šè¢«æ³¨å†Œä¸ºå…¨å±€
        },
      ],
      exports: [WINSTON_MODULE_PROVIDER], // å¯¼å‡ºæä¾›è€…
      global: true, // å…³é”®ï¼šè¿™é‡Œä¼šè‡ªåŠ¨è®¾ç½®ä¸ºå…¨å±€
    };
  }
}
```

```typescript
// nestjs-pino åº“å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ï¼‰
export class LoggerModule {
  static forRoot(options: Params): DynamicModule {
    return {
      module: LoggerModule,
      providers: [
        {
          provide: PinoLogger,
          useFactory: () => new PinoLogger(options),
        },
      ],
      exports: [PinoLogger],
      global: true, // è‡ªåŠ¨è®¾ç½®ä¸ºå…¨å±€
    };
  }
}
```

### 2. **éªŒè¯è¿™ä¸ªå‡è®¾**

è®©æˆ‘ä»¬åšä¸€ä¸ªå®éªŒæ¥éªŒè¯ï¼š

```typescript
// src/log/log.module.ts - å®Œå…¨ç§»é™¤æ—¥å¿—é…ç½®
import { Module } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';

// æ³¨é‡Šæ‰æ‰€æœ‰æ—¥å¿—é…ç½®
@Module({
  /*
  imports: [
    LoggerModule.forRoot({...}),
    WinstonModule.forRoot({...}),
  ],
  */
  providers: [LogService],
  controllers: [LogController],
})
export class LogModule {}
```

å¦‚æœæˆ‘ä»¬å®Œå…¨ç§»é™¤ `LoggerModule.forRoot()` å’Œ `WinstonModule.forRoot()`ï¼Œé‚£ä¹ˆ `ExceptionController` å°±ä¼šæŠ¥é”™ã€‚

### 3. **åº”ç”¨å¯åŠ¨æ—¶çš„ä¾èµ–æ³¨å…¥åˆ†æ**

å½“åº”ç”¨å¯åŠ¨æ—¶ï¼ŒNestJS ä¼šï¼š

1. **æ‰«ææ‰€æœ‰æ¨¡å—çš„ `imports`**
2. **æ‰§è¡Œ `forRoot()` æ–¹æ³•**ï¼Œè¿™äº›æ–¹æ³•è¿”å›çš„ `DynamicModule` é€šå¸¸åŒ…å« `global: true`
3. **å°†å…¨å±€æä¾›è€…æ³¨å†Œåˆ°æ ¹å®¹å™¨**
4. **æ‰€æœ‰æ¨¡å—éƒ½å¯ä»¥è®¿é—®è¿™äº›å…¨å±€æä¾›è€…**

### 4. **æ­£ç¡®çš„æµ‹è¯•æ–¹æ³•**

è¦éªŒè¯æ¨¡å—è¾¹ç•Œï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª**ä¸ä¾èµ– `forRoot()` çš„è‡ªå®šä¹‰æœåŠ¡**ï¼š

```typescript
// src/log/custom-logger.service.ts
import { Injectable } from '@nestjs/common';

@Injectable()
export class CustomLoggerService {
  log(message: string) {
    console.log(`[CustomLogger]: ${message}`);
  }
}
```

```typescript
// src/log/log.module.ts
import { Module } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';
import { CustomLoggerService } from './custom-logger.service';
import { LoggerModule } from 'nestjs-pino';
import { WinstonModule } from 'nest-winston';
// ... other imports

// ç§»é™¤ @Global() è£…é¥°å™¨
@Module({
  imports: [
    LoggerModule.forRoot({...}), // è¿™äº›ä¼šè‡ªåŠ¨æˆä¸ºå…¨å±€
    WinstonModule.forRoot({...}), // è¿™äº›ä¼šè‡ªåŠ¨æˆä¸ºå…¨å±€
  ],
  providers: [
    LogService,
    CustomLoggerService, // è¿™ä¸ªä¸ä¼šæˆä¸ºå…¨å±€
  ],
  controllers: [LogController],
  exports: [CustomLoggerService], // éœ€è¦æ˜¾å¼å¯¼å‡º
})
export class LogModule {}
```

```typescript
// src/exception/exception.controller.ts
import { Controller, Inject } from '@nestjs/common';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { PinoLogger } from 'nestjs-pino';
import { CustomLoggerService } from '../log/custom-logger.service';

@Controller('exception')
export class ExceptionController {
  constructor(
    @Inject(WINSTON_MODULE_PROVIDER)
    private readonly winstonLogger: any, // è¿™ä¸ªå¯ä»¥æ³¨å…¥ï¼ˆå…¨å±€ï¼‰
    private readonly pinoLogger: PinoLogger, // è¿™ä¸ªå¯ä»¥æ³¨å…¥ï¼ˆå…¨å±€ï¼‰
    private readonly customLogger: CustomLoggerService, // è¿™ä¸ªä¼šæŠ¥é”™ï¼
  ) {}
}
```

### 5. **ä¿®å¤å¼‚å¸¸æ¨¡å—çš„ä¾èµ–**

å¦‚æœæ‚¨æƒ³è¦åœ¨ `ExceptionController` ä¸­ä½¿ç”¨ `CustomLoggerService`ï¼Œéœ€è¦ï¼š

#### **æ–¹æ¡ˆä¸€ï¼šåœ¨å¼‚å¸¸æ¨¡å—ä¸­å¯¼å…¥æ—¥å¿—æ¨¡å—**

```typescript
// src/exception/exception.module.ts
import { Module } from '@nestjs/common';
import { ExceptionController } from './exception.controller';
import { LogModule } from '../log/log.module';

@Module({
  imports: [LogModule], // å¯¼å…¥æ—¥å¿—æ¨¡å—
  controllers: [ExceptionController],
})
export class ExceptionModule {}
```

#### **æ–¹æ¡ˆäºŒï¼šè®©æ—¥å¿—æ¨¡å—æˆä¸ºå…¨å±€æ¨¡å—**

```typescript
// src/log/log.module.ts
import { Module, Global } from '@nestjs/common';

@Global() // æ¢å¤å…¨å±€è£…é¥°å™¨
@Module({
  imports: [
    LoggerModule.forRoot({...}),
    WinstonModule.forRoot({...}),
  ],
  providers: [LogService, CustomLoggerService],
  controllers: [LogController],
  exports: [CustomLoggerService], // å…¨å±€æ¨¡å—çš„å¯¼å‡ºä¼šåœ¨æ‰€æœ‰åœ°æ–¹å¯ç”¨
})
export class LogModule {}
```

### 6. **æµ‹è¯•éªŒè¯**

```typescript
// æµ‹è¯•å“ªäº›æœåŠ¡æ˜¯å…¨å±€å¯ç”¨çš„
@Controller('exception')
export class ExceptionController {
  constructor(
    // âœ… å¯ä»¥æ³¨å…¥ - forRoot() è‡ªåŠ¨å…¨å±€
    @Inject(WINSTON_MODULE_PROVIDER) private winstonLogger: any,
    // âœ… å¯ä»¥æ³¨å…¥ - forRoot() è‡ªåŠ¨å…¨å±€  
    private pinoLogger: PinoLogger,
    // âŒ æ— æ³•æ³¨å…¥ - éœ€è¦å¯¼å…¥æ¨¡å—æˆ–è®¾ä¸ºå…¨å±€
    // private customLogger: CustomLoggerService,
  ) {}
  
  @Post('/')
  test() {
    this.winstonLogger.info('Winston works globally');
    this.pinoLogger.info('Pino works globally');
    // this.customLogger.log('This would fail');
  }
}
```

## æ€»ç»“

**ä¸ºä»€ä¹ˆ Winston å’Œ Pino å¯ä»¥åœ¨å¼‚å¸¸æ§åˆ¶å™¨ä¸­ä½¿ç”¨ï¼š**

1. **`forRoot()` æ–¹æ³•è‡ªåŠ¨åˆ›å»ºå…¨å±€æä¾›è€…**
2. **å³ä½¿ `LogModule` æ²¡æœ‰ `@Global()` è£…é¥°å™¨**
3. **è¿™æ˜¯ç¬¬ä¸‰æ–¹åº“çš„è®¾è®¡ï¼Œæ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨**

**éªŒè¯æ¨¡å—è¾¹ç•Œçš„æ­£ç¡®æ–¹æ³•ï¼š**
- åˆ›å»ºè‡ªå®šä¹‰æœåŠ¡ï¼ˆä¸ä½¿ç”¨ `forRoot()`ï¼‰
- æµ‹è¯•è¿™äº›æœåŠ¡æ˜¯å¦éœ€è¦æ˜¾å¼å¯¼å…¥æ¨¡å—

è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆæ‚¨çš„ä»£ç èƒ½æ­£å¸¸è¿è¡Œï¼è¿™æ˜¯ NestJS ç”Ÿæ€ä¸­å¸¸è§çš„è®¾è®¡æ¨¡å¼ã€‚

```typescript
// nest-winston åº“å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ï¼‰
export class WinstonModule {
  static forRoot(options: WinstonModuleOptions): DynamicModule {
    return {
      module: WinstonModule,
      providers: [
        {
          provide: WINSTON_MODULE_PROVIDER,
          useFactory: () => winston.createLogger(options),
          scope: Scope.DEFAULT, // é»˜è®¤ä½œç”¨åŸŸï¼Œå®é™…ä¸Šä¼šè¢«æ³¨å†Œä¸ºå…¨å±€
        },
      ],
      exports: [WINSTON_MODULE_PROVIDER], // å¯¼å‡ºæä¾›è€…
      global: true, // å…³é”®ï¼šè¿™é‡Œä¼šè‡ªåŠ¨è®¾ç½®ä¸ºå…¨å±€
    };
  }
}
```

```typescript
// nestjs-pino åº“å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ï¼‰
export class LoggerModule {
  static forRoot(options: Params): DynamicModule {
    return {
      module: LoggerModule,
      providers: [
        {
          provide: PinoLogger,
          useFactory: () => new PinoLogger(options),
        },
      ],
      exports: [PinoLogger],
      global: true, // è‡ªåŠ¨è®¾ç½®ä¸ºå…¨å±€
    };
  }
}
```

```typescript
// src/log/log.module.ts - å®Œå…¨ç§»é™¤æ—¥å¿—é…ç½®
import { Module } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';

// æ³¨é‡Šæ‰æ‰€æœ‰æ—¥å¿—é…ç½®
@Module({
  /*
  imports: [
    LoggerModule.forRoot({...}),
    WinstonModule.forRoot({...}),
  ],
  */
  providers: [LogService],
  controllers: [LogController],
})
export class LogModule {}
```

```typescript
// src/log/custom-logger.service.ts
import { Injectable } from '@nestjs/common';

@Injectable()
export class CustomLoggerService {
  log(message: string) {
    console.log(`[CustomLogger]: ${message}`);
  }
}
```

```typescript
// src/log/log.module.ts
import { Module } from '@nestjs/common';
import { LogService } from './log.service';
import { LogController } from './log.controller';
import { CustomLoggerService } from './custom-logger.service';
import { LoggerModule } from 'nestjs-pino';
import { WinstonModule } from 'nest-winston';
// ... other imports

// ç§»é™¤ @Global() è£…é¥°å™¨
@Module({
  imports: [
    LoggerModule.forRoot({...}), // è¿™äº›ä¼šè‡ªåŠ¨æˆä¸ºå…¨å±€
    WinstonModule.forRoot({...}), // è¿™äº›ä¼šè‡ªåŠ¨æˆä¸ºå…¨å±€
  ],
  providers: [
    LogService,
    CustomLoggerService, // è¿™ä¸ªä¸ä¼šæˆä¸ºå…¨å±€
  ],
  controllers: [LogController],
  exports: [CustomLoggerService], // éœ€è¦æ˜¾å¼å¯¼å‡º
})
export class LogModule {}
```

```typescript
// src/exception/exception.controller.ts
import { Controller, Inject } from '@nestjs/common';
import { WINSTON_MODULE_PROVIDER } from 'nest-winston';
import { PinoLogger } from 'nestjs-pino';
import { CustomLoggerService } from '../log/custom-logger.service';

@Controller('exception')
export class ExceptionController {
  constructor(
    @Inject(WINSTON_MODULE_PROVIDER)
    private readonly winstonLogger: any, // è¿™ä¸ªå¯ä»¥æ³¨å…¥ï¼ˆå…¨å±€ï¼‰
    private readonly pinoLogger: PinoLogger, // è¿™ä¸ªå¯ä»¥æ³¨å…¥ï¼ˆå…¨å±€ï¼‰
    private readonly customLogger: CustomLoggerService, // è¿™ä¸ªä¼šæŠ¥é”™ï¼
  ) {}
}
```

```typescript
// src/exception/exception.module.ts
import { Module } from '@nestjs/common';
import { ExceptionController } from './exception.controller';
import { LogModule } from '../log/log.module';

@Module({
  imports: [LogModule], // å¯¼å…¥æ—¥å¿—æ¨¡å—
  controllers: [ExceptionController],
})
export class ExceptionModule {}
```

```typescript
// src/log/log.module.ts
import { Module, Global } from '@nestjs/common';

@Global() // æ¢å¤å…¨å±€è£…é¥°å™¨
@Module({
  imports: [
    LoggerModule.forRoot({...}),
    WinstonModule.forRoot({...}),
  ],
  providers: [LogService, CustomLoggerService],
  controllers: [LogController],
  exports: [CustomLoggerService], // å…¨å±€æ¨¡å—çš„å¯¼å‡ºä¼šåœ¨æ‰€æœ‰åœ°æ–¹å¯ç”¨
})
export class LogModule {}
```

```typescript
// æµ‹è¯•å“ªäº›æœåŠ¡æ˜¯å…¨å±€å¯ç”¨çš„
@Controller('exception')
export class ExceptionController {
  constructor(
    // âœ… å¯ä»¥æ³¨å…¥ - forRoot() è‡ªåŠ¨å…¨å±€
    @Inject(WINSTON_MODULE_PROVIDER) private winstonLogger: any,
    // âœ… å¯ä»¥æ³¨å…¥ - forRoot() è‡ªåŠ¨å…¨å±€  
    private pinoLogger: PinoLogger,
    // âŒ æ— æ³•æ³¨å…¥ - éœ€è¦å¯¼å…¥æ¨¡å—æˆ–è®¾ä¸ºå…¨å±€
    // private customLogger: CustomLoggerService,
  ) {}
  
  @Post('/')
  test() {
    this.winstonLogger.info('Winston works globally');
    this.pinoLogger.info('Pino works globally');
    // this.customLogger.log('This would fail');
  }
}
```

---

**User**

å¦‚æœæˆ‘ä¹Ÿæƒ³è®¾è®¡è¿™æ ·çš„ç¬¬ä¸‰æ–¹åº“ï¼ŒforRootå†…éƒ¨ä¸€èˆ¬æ˜¯æ€ä¹ˆå®ç°çš„

---

**Cursor**

æˆ‘æ¥è¯¦ç»†ä¸ºæ‚¨ä»‹ç»å¦‚ä½•è®¾è®¡ä¸€ä¸ªç±»ä¼¼çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå®ç° `forRoot()` æ¨¡å¼çš„å…¨å±€æä¾›è€…ã€‚

## 1. Dynamic Module åŸºç¡€æ¦‚å¿µ

```typescript
// åŠ¨æ€æ¨¡å—æ¥å£
interface DynamicModule {
  module: Type<any>;
  imports?: Array<Type<any> | DynamicModule | Promise<DynamicModule> | ForwardReference>;
  providers?: Provider[];
  controllers?: Type<any>[];
  exports?: Array<string | symbol | Type<any> | DynamicModule>;
  global?: boolean; // å…³é”®ï¼šè®¾ç½®ä¸ºå…¨å±€æ¨¡å—
}
```

## 2. å®Œæ•´çš„ç¬¬ä¸‰æ–¹åº“å®ç°ç¤ºä¾‹

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ç¼“å­˜åº“ä½œä¸ºç¤ºä¾‹ï¼š

### 2.1 å®šä¹‰é…ç½®æ¥å£

```typescript
// src/cache/interfaces/cache-options.interface.ts
export interface CacheModuleOptions {
  host?: string;
  port?: number;
  ttl?: number; // Time to live
  prefix?: string;
  maxKeys?: number;
}

export interface CacheModuleAsyncOptions {
  useFactory?: (...args: any[]) => Promise<CacheModuleOptions> | CacheModuleOptions;
  inject?: any[];
  imports?: any[];
}
```

### 2.2 åˆ›å»ºæ ¸å¿ƒæœåŠ¡

```typescript
// src/cache/services/cache.service.ts
import { Injectable, Inject } from '@nestjs/common';
import { CACHE_MODULE_OPTIONS } from '../constants/cache.constants';
import { CacheModuleOptions } from '../interfaces/cache-options.interface';

@Injectable()
export class CacheService {
  private cache = new Map<string, { value: any; expiry: number }>();
  
  constructor(
    @Inject(CACHE_MODULE_OPTIONS) 
    private readonly options: CacheModuleOptions,
  ) {
    console.log('CacheService initialized with options:', options);
  }

  set(key: string, value: any, ttl?: number): void {
    const actualTtl = ttl || this.options.ttl || 3600000; // é»˜è®¤1å°æ—¶
    const prefixedKey = this.options.prefix ? `${this.options.prefix}:${key}` : key;
    const expiry = Date.now() + actualTtl;
    
    this.cache.set(prefixedKey, { value, expiry });
    
    // ç®€å•çš„è¿‡æœŸæ¸…ç†
    setTimeout(() => {
      this.cache.delete(prefixedKey);
    }, actualTtl);
  }

  get(key: string): any {
    const prefixedKey = this.options.prefix ? `${this.options.prefix}:${key}` : key;
    const item = this.cache.get(prefixedKey);
    
    if (!item) return null;
    
    if (Date.now() > item.expiry) {
      this.cache.delete(prefixedKey);
      return null;
    }
    
    return item.value;
  }

  del(key: string): boolean {
    const prefixedKey = this.options.prefix ? `${this.options.prefix}:${key}` : key;
    return this.cache.delete(prefixedKey);
  }

  clear(): void {
    this.cache.clear();
  }

  getStats() {
    return {
      size: this.cache.size,
      maxKeys: this.options.maxKeys,
      prefix: this.options.prefix,
    };
  }
}
```

### 2.3 å®šä¹‰å¸¸é‡

```typescript
// src/cache/constants/cache.constants.ts
export const CACHE_MODULE_OPTIONS = 'CACHE_MODULE_OPTIONS';
export const CACHE_MODULE_PROVIDER = 'CACHE_MODULE_PROVIDER';
```

### 2.4 æ ¸å¿ƒæ¨¡å—å®ç°

```typescript
// src/cache/cache-core.module.ts
import { Module, DynamicModule, Provider, Global } from '@nestjs/common';
import { CacheService } from './services/cache.service';
import { CacheModuleOptions, CacheModuleAsyncOptions } from './interfaces/cache-options.interface';
import { CACHE_MODULE_OPTIONS } from './constants/cache.constants';

@Global() // è®¾ç½®ä¸ºå…¨å±€æ¨¡å—
@Module({})
export class CacheCoreModule {
  /**
   * åŒæ­¥é…ç½®æ–¹æ³•
   */
  static forRoot(options: CacheModuleOptions): DynamicModule {
    const providers: Provider[] = [
      {
        provide: CACHE_MODULE_OPTIONS,
        useValue: options,
      },
      CacheService,
    ];

    return {
      module: CacheCoreModule,
      providers,
      exports: [CacheService], // å¯¼å‡ºæœåŠ¡ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
    };
  }

  /**
   * å¼‚æ­¥é…ç½®æ–¹æ³•
   */
  static forRootAsync(options: CacheModuleAsyncOptions): DynamicModule {
    const providers: Provider[] = [
      ...this.createAsyncProviders(options),
      CacheService,
    ];

    return {
      module: CacheCoreModule,
      imports: options.imports || [],
      providers,
      exports: [CacheService],
    };
  }

  /**
   * åˆ›å»ºå¼‚æ­¥æä¾›è€…
   */
  private static createAsyncProviders(options: CacheModuleAsyncOptions): Provider[] {
    const providers: Provider[] = [];

    if (options.useFactory) {
      providers.push({
        provide: CACHE_MODULE_OPTIONS,
        useFactory: options.useFactory,
        inject: options.inject || [],
      });
    }

    return providers;
  }
}
```

### 2.5 å…¬å…±æ¨¡å—æ¥å£

```typescript
// src/cache/cache.module.ts
import { Module, DynamicModule } from '@nestjs/common';
import { CacheCoreModule } from './cache-core.module';
import { CacheModuleOptions, CacheModuleAsyncOptions } from './interfaces/cache-options.interface';

@Module({})
export class CacheModule {
  /**
   * åŒæ­¥é…ç½® - ç›´æ¥ä¼ å…¥é…ç½®å¯¹è±¡
   */
  static forRoot(options: CacheModuleOptions): DynamicModule {
    return {
      module: CacheModule,
      imports: [CacheCoreModule.forRoot(options)],
    };
  }

  /**
   * å¼‚æ­¥é…ç½® - ä½¿ç”¨å·¥å‚å‡½æ•°
   */
  static forRootAsync(options: CacheModuleAsyncOptions): DynamicModule {
    return {
      module: CacheModule,
      imports: [CacheCoreModule.forRootAsync(options)],
    };
  }

  /**
   * ç‰¹æ€§æ¨¡å— - ä¸ºç‰¹å®šæ¨¡å—æä¾›ç¼“å­˜åŠŸèƒ½
   */
  static forFeature(): DynamicModule {
    return {
      module: CacheModule,
      // ä¸æä¾›æ–°çš„æœåŠ¡ï¼Œåªæ˜¯é‡æ–°å¯¼å‡ºå…¨å±€çš„ CacheService
      exports: [CacheCoreModule],
    };
  }
}
```

### 2.6 å¯¼å‡ºæ–‡ä»¶

```typescript
// src/cache/index.ts
export * from './cache.module';
export * from './services/cache.service';
export * from './interfaces/cache-options.interface';
export * from './constants/cache.constants';
```

## 3. é«˜çº§é…ç½®æ¨¡å¼

### 3.1 æ”¯æŒå¤šå®ä¾‹

```typescript
// src/cache/cache.module.ts (å¢å¼ºç‰ˆ)
export class CacheModule {
  /**
   * æ³¨å†Œå‘½åå®ä¾‹
   */
  static forRoot(options: CacheModuleOptions, name?: string): DynamicModule {
    const optionsProvider = name 
      ? `${CACHE_MODULE_OPTIONS}_${name}`
      : CACHE_MODULE_OPTIONS;
    
    const serviceProvider = name 
      ? `${CACHE_MODULE_PROVIDER}_${name}`
      : CacheService;

    return {
      module: CacheModule,
      imports: [
        CacheCoreModule.forRoot({
          ...options,
          name,
        }),
      ],
      providers: [
        {
          provide: serviceProvider,
          useFactory: (opts: CacheModuleOptions) => {
            return new CacheService(opts);
          },
          inject: [optionsProvider],
        },
      ],
      exports: [serviceProvider],
      global: true,
    };
  }
}
```

### 3.2 æ”¯æŒé…ç½®éªŒè¯

```typescript
// src/cache/validators/cache-options.validator.ts
import { plainToClass, Transform } from 'class-transformer';
import { IsNumber, IsString, IsOptional, Min, Max } from 'class-validator';

export class CacheModuleOptionsValidator {
  @IsOptional()
  @IsString()
  host?: string = 'localhost';

  @IsOptional()
  @IsNumber()
  @Min(1)
  @Max(65535)
  port?: number = 6379;

  @IsOptional()
  @IsNumber()
  @Min(1000) // æœ€å°‘1ç§’
  ttl?: number = 3600000; // é»˜è®¤1å°æ—¶

  @IsOptional()
  @IsString()
  prefix?: string;

  @IsOptional()
  @IsNumber()
  @Min(1)
  maxKeys?: number = 1000;

  static validate(options: CacheModuleOptions): CacheModuleOptionsValidator {
    return plainToClass(CacheModuleOptionsValidator, options);
  }
}
```

### 3.3 æ”¯æŒç¯å¢ƒé…ç½®

```typescript
// src/cache/cache.module.ts (å®Œæ•´ç‰ˆ)
import { ConfigService } from '@nestjs/config';

export class CacheModule {
  static forRootAsync(options: CacheModuleAsyncOptions): DynamicModule {
    return {
      module: CacheModule,
      imports: [
        CacheCoreModule.forRootAsync({
          ...options,
          useFactory: async (...args: any[]) => {
            const config = options.useFactory 
              ? await options.useFactory(...args)
              : {};
            
            // é…ç½®éªŒè¯
            const validatedConfig = CacheModuleOptionsValidator.validate(config);
            
            return validatedConfig;
          },
        }),
      ],
    };
  }

  /**
   * ä¾¿æ·æ–¹æ³•ï¼šä» ConfigService åŠ è½½é…ç½®
   */
  static forRootFromConfig(): DynamicModule {
    return this.forRootAsync({
      useFactory: (configService: ConfigService) => ({
        host: configService.get<string>('CACHE_HOST', 'localhost'),
        port: configService.get<number>('CACHE_PORT', 6379),
        ttl: configService.get<number>('CACHE_TTL', 3600000),
        prefix: configService.get<string>('CACHE_PREFIX', 'app'),
        maxKeys: configService.get<number>('CACHE_MAX_KEYS', 1000),
      }),
      inject: [ConfigService],
      imports: [], // ConfigService å¦‚æœæ˜¯å…¨å±€çš„ï¼Œè¿™é‡Œå¯ä»¥ä¸ºç©º
    });
  }
}
```

## 4. ä½¿ç”¨ç¤ºä¾‹

### 4.1 åŸºæœ¬ä½¿ç”¨

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { CacheModule } from './cache';

@Module({
  imports: [
    // åŒæ­¥é…ç½®
    CacheModule.forRoot({
      host: 'localhost',
      port: 6379,
      ttl: 3600000,
      prefix: 'myapp',
    }),
    
    // æˆ–è€…å¼‚æ­¥é…ç½®
    CacheModule.forRootAsync({
      useFactory: () => ({
        host: process.env.CACHE_HOST || 'localhost',
        port: parseInt(process.env.CACHE_PORT) || 6379,
        ttl: 3600000,
      }),
    }),
    
    // æˆ–è€…ä»é…ç½®æœåŠ¡åŠ è½½
    CacheModule.forRootFromConfig(),
  ],
})
export class AppModule {}
```

### 4.2 åœ¨æœåŠ¡ä¸­ä½¿ç”¨

```typescript
// src/user/user.service.ts
import { Injectable } from '@nestjs/common';
import { CacheService } from '../cache';

@Injectable()
export class UserService {
  constructor(private readonly cacheService: CacheService) {}

  async getUser(id: string) {
    // å…ˆä»ç¼“å­˜è·å–
    const cached = this.cacheService.get(`user:${id}`);
    if (cached) {
      return cached;
    }

    // ä»æ•°æ®åº“è·å–
    const user = await this.fetchUserFromDatabase(id);
    
    // å­˜å…¥ç¼“å­˜
    this.cacheService.set(`user:${id}`, user, 1800000); // 30åˆ†é’Ÿ
    
    return user;
  }

  private async fetchUserFromDatabase(id: string) {
    // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
    return { id, name: 'Test User', email: 'test@example.com' };
  }
}
```

## 5. æµ‹è¯•ç¬¬ä¸‰æ–¹åº“

```typescript
// src/cache/cache.service.spec.ts
import { Test, TestingModule } from '@nestjs/testing';
import { CacheService } from './services/cache.service';
import { CacheModule } from './cache.module';

describe('CacheService', () => {
  let service: CacheService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      imports: [
        CacheModule.forRoot({
          ttl: 1000,
          prefix: 'test',
        }),
      ],
    }).compile();

    service = module.get<CacheService>(CacheService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });

  it('should set and get values', () => {
    service.set('key1', 'value1');
    expect(service.get('key1')).toBe('value1');
  });

  it('should handle expiration', (done) => {
    service.set('key2', 'value2', 100);
    
    setTimeout(() => {
      expect(service.get('key2')).toBeNull();
      done();
    }, 150);
  });
});
```

## 6. å…³é”®è¦ç‚¹æ€»ç»“

### forRoot() å®ç°çš„æ ¸å¿ƒè¦ç´ ï¼š

1. **è¿”å› DynamicModule**ï¼šåŒ…å« moduleã€providersã€exports ç­‰
2. **è®¾ç½® global: true**ï¼šä½¿æ¨¡å—æˆä¸ºå…¨å±€æ¨¡å—
3. **æä¾›é…ç½®æä¾›è€…**ï¼šä½¿ç”¨ token æ³¨å…¥é…ç½®
4. **å¯¼å‡ºæ ¸å¿ƒæœåŠ¡**ï¼šè®©å…¶ä»–æ¨¡å—å¯ä»¥ä½¿ç”¨
5. **æ”¯æŒå¼‚æ­¥é…ç½®**ï¼šforRootAsync æ–¹æ³•

### æœ€ä½³å®è·µï¼š

1. **åˆ†ç¦»æ ¸å¿ƒæ¨¡å—å’Œå…¬å…±æ¥å£**
2. **æä¾›å¤šç§é…ç½®æ–¹å¼**ï¼ˆåŒæ­¥ã€å¼‚æ­¥ã€ä»é…ç½®æœåŠ¡ï¼‰
3. **é…ç½®éªŒè¯å’Œé»˜è®¤å€¼**
4. **å®Œå–„çš„ TypeScript ç±»å‹å®šä¹‰**
5. **å•å…ƒæµ‹è¯•è¦†ç›–**

è¿™æ ·è®¾è®¡çš„ç¬¬ä¸‰æ–¹åº“å°±èƒ½åƒ Winston å’Œ Pino ä¸€æ ·ï¼Œé€šè¿‡ `forRoot()` æ–¹æ³•è‡ªåŠ¨åˆ›å»ºå…¨å±€å¯ç”¨çš„æä¾›è€…ï¼

```typescript
// åŠ¨æ€æ¨¡å—æ¥å£
interface DynamicModule {
  module: Type<any>;
  imports?: Array<Type<any> | DynamicModule | Promise<DynamicModule> | ForwardReference>;
  providers?: Provider[];
  controllers?: Type<any>[];
  exports?: Array<string | symbol | Type<any> | DynamicModule>;
  global?: boolean; // å…³é”®ï¼šè®¾ç½®ä¸ºå…¨å±€æ¨¡å—
}
```

```typescript
// src/cache/interfaces/cache-options.interface.ts
export interface CacheModuleOptions {
  host?: string;
  port?: number;
  ttl?: number; // Time to live
  prefix?: string;
  maxKeys?: number;
}

export interface CacheModuleAsyncOptions {
  useFactory?: (...args: any[]) => Promise<CacheModuleOptions> | CacheModuleOptions;
  inject?: any[];
  imports?: any[];
}
```

```typescript
// src/cache/services/cache.service.ts
import { Injectable, Inject } from '@nestjs/common';
import { CACHE_MODULE_OPTIONS } from '../constants/cache.constants';
import { CacheModuleOptions } from '../interfaces/cache-options.interface';

@Injectable()
export class CacheService {
  private cache = new Map<string, { value: any; expiry: number }>();
  
  constructor(
    @Inject(CACHE_MODULE_OPTIONS) 
    private readonly options: CacheModuleOptions,
  ) {
    console.log('CacheService initialized with options:', options);
  }

  set(key: string, value: any, ttl?: number): void {
    const actualTtl = ttl || this.options.ttl || 3600000; // é»˜è®¤1å°æ—¶
    const prefixedKey = this.options.prefix ? `${this.options.prefix}:${key}` : key;
    const expiry = Date.now() + actualTtl;
    
    this.cache.set(prefixedKey, { value, expiry });
    
    // ç®€å•çš„è¿‡æœŸæ¸…ç†
    setTimeout(() => {
      this.cache.delete(prefixedKey);
    }, actualTtl);
  }

  get(key: string): any {
    const prefixedKey = this.options.prefix ? `${this.options.prefix}:${key}` : key;
    const item = this.cache.get(prefixedKey);
    
    if (!item) return null;
    
    if (Date.now() > item.expiry) {
      this.cache.delete(prefixedKey);
      return null;
    }
    
    return item.value;
  }

  del(key: string): boolean {
    const prefixedKey = this.options.prefix ? `${this.options.prefix}:${key}` : key;
    return this.cache.delete(prefixedKey);
  }

  clear(): void {
    this.cache.clear();
  }

  getStats() {
    return {
      size: this.cache.size,
      maxKeys: this.options.maxKeys,
      prefix: this.options.prefix,
    };
  }
}
```

```typescript
// src/cache/constants/cache.constants.ts
export const CACHE_MODULE_OPTIONS = 'CACHE_MODULE_OPTIONS';
export const CACHE_MODULE_PROVIDER = 'CACHE_MODULE_PROVIDER';
```

```typescript
// src/cache/cache-core.module.ts
import { Module, DynamicModule, Provider, Global } from '@nestjs/common';
import { CacheService } from './services/cache.service';
import { CacheModuleOptions, CacheModuleAsyncOptions } from './interfaces/cache-options.interface';
import { CACHE_MODULE_OPTIONS } from './constants/cache.constants';

@Global() // è®¾ç½®ä¸ºå…¨å±€æ¨¡å—
@Module({})
export class CacheCoreModule {
  /**
   * åŒæ­¥é…ç½®æ–¹æ³•
   */
  static forRoot(options: CacheModuleOptions): DynamicModule {
    const providers: Provider[] = [
      {
        provide: CACHE_MODULE_OPTIONS,
        useValue: options,
      },
      CacheService,
    ];

    return {
      module: CacheCoreModule,
      providers,
      exports: [CacheService], // å¯¼å‡ºæœåŠ¡ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
    };
  }

  /**
   * å¼‚æ­¥é…ç½®æ–¹æ³•
   */
  static forRootAsync(options: CacheModuleAsyncOptions): DynamicModule {
    const providers: Provider[] = [
      ...this.createAsyncProviders(options),
      CacheService,
    ];

    return {
      module: CacheCoreModule,
      imports: options.imports || [],
      providers,
      exports: [CacheService],
    };
  }

  /**
   * åˆ›å»ºå¼‚æ­¥æä¾›è€…
   */
  private static createAsyncProviders(options: CacheModuleAsyncOptions): Provider[] {
    const providers: Provider[] = [];

    if (options.useFactory) {
      providers.push({
        provide: CACHE_MODULE_OPTIONS,
        useFactory: options.useFactory,
        inject: options.inject || [],
      });
    }

    return providers;
  }
}
```

```typescript
// src/cache/cache.module.ts
import { Module, DynamicModule } from '@nestjs/common';
import { CacheCoreModule } from './cache-core.module';
import { CacheModuleOptions, CacheModuleAsyncOptions } from './interfaces/cache-options.interface';

@Module({})
export class CacheModule {
  /**
   * åŒæ­¥é…ç½® - ç›´æ¥ä¼ å…¥é…ç½®å¯¹è±¡
   */
  static forRoot(options: CacheModuleOptions): DynamicModule {
    return {
      module: CacheModule,
      imports: [CacheCoreModule.forRoot(options)],
    };
  }

  /**
   * å¼‚æ­¥é…ç½® - ä½¿ç”¨å·¥å‚å‡½æ•°
   */
  static forRootAsync(options: CacheModuleAsyncOptions): DynamicModule {
    return {
      module: CacheModule,
      imports: [CacheCoreModule.forRootAsync(options)],
    };
  }

  /**
   * ç‰¹æ€§æ¨¡å— - ä¸ºç‰¹å®šæ¨¡å—æä¾›ç¼“å­˜åŠŸèƒ½
   */
  static forFeature(): DynamicModule {
    return {
      module: CacheModule,
      // ä¸æä¾›æ–°çš„æœåŠ¡ï¼Œåªæ˜¯é‡æ–°å¯¼å‡ºå…¨å±€çš„ CacheService
      exports: [CacheCoreModule],
    };
  }
}
```

```typescript
// src/cache/index.ts
export * from './cache.module';
export * from './services/cache.service';
export * from './interfaces/cache-options.interface';
export * from './constants/cache.constants';
```

```typescript
// src/cache/cache.module.ts (å¢å¼ºç‰ˆ)
export class CacheModule {
  /**
   * æ³¨å†Œå‘½åå®ä¾‹
   */
  static forRoot(options: CacheModuleOptions, name?: string): DynamicModule {
    const optionsProvider = name 
      ? `${CACHE_MODULE_OPTIONS}_${name}`
      : CACHE_MODULE_OPTIONS;
    
    const serviceProvider = name 
      ? `${CACHE_MODULE_PROVIDER}_${name}`
      : CacheService;

    return {
      module: CacheModule,
      imports: [
        CacheCoreModule.forRoot({
          ...options,
          name,
        }),
      ],
      providers: [
        {
          provide: serviceProvider,
          useFactory: (opts: CacheModuleOptions) => {
            return new CacheService(opts);
          },
          inject: [optionsProvider],
        },
      ],
      exports: [serviceProvider],
      global: true,
    };
  }
}
```

```typescript
// src/cache/validators/cache-options.validator.ts
import { plainToClass, Transform } from 'class-transformer';
import { IsNumber, IsString, IsOptional, Min, Max } from 'class-validator';

export class CacheModuleOptionsValidator {
  @IsOptional()
  @IsString()
  host?: string = 'localhost';

  @IsOptional()
  @IsNumber()
  @Min(1)
  @Max(65535)
  port?: number = 6379;

  @IsOptional()
  @IsNumber()
  @Min(1000) // æœ€å°‘1ç§’
  ttl?: number = 3600000; // é»˜è®¤1å°æ—¶

  @IsOptional()
  @IsString()
  prefix?: string;

  @IsOptional()
  @IsNumber()
  @Min(1)
  maxKeys?: number = 1000;

  static validate(options: CacheModuleOptions): CacheModuleOptionsValidator {
    return plainToClass(CacheModuleOptionsValidator, options);
  }
}
```

```typescript
// src/cache/cache.module.ts (å®Œæ•´ç‰ˆ)
import { ConfigService } from '@nestjs/config';

export class CacheModule {
  static forRootAsync(options: CacheModuleAsyncOptions): DynamicModule {
    return {
      module: CacheModule,
      imports: [
        CacheCoreModule.forRootAsync({
          ...options,
          useFactory: async (...args: any[]) => {
            const config = options.useFactory 
              ? await options.useFactory(...args)
              : {};
            
            // é…ç½®éªŒè¯
            const validatedConfig = CacheModuleOptionsValidator.validate(config);
            
            return validatedConfig;
          },
        }),
      ],
    };
  }

  /**
   * ä¾¿æ·æ–¹æ³•ï¼šä» ConfigService åŠ è½½é…ç½®
   */
  static forRootFromConfig(): DynamicModule {
    return this.forRootAsync({
      useFactory: (configService: ConfigService) => ({
        host: configService.get<string>('CACHE_HOST', 'localhost'),
        port: configService.get<number>('CACHE_PORT', 6379),
        ttl: configService.get<number>('CACHE_TTL', 3600000),
        prefix: configService.get<string>('CACHE_PREFIX', 'app'),
        maxKeys: configService.get<number>('CACHE_MAX_KEYS', 1000),
      }),
      inject: [ConfigService],
      imports: [], // ConfigService å¦‚æœæ˜¯å…¨å±€çš„ï¼Œè¿™é‡Œå¯ä»¥ä¸ºç©º
    });
  }
}
```

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { CacheModule } from './cache';

@Module({
  imports: [
    // åŒæ­¥é…ç½®
    CacheModule.forRoot({
      host: 'localhost',
      port: 6379,
      ttl: 3600000,
      prefix: 'myapp',
    }),
    
    // æˆ–è€…å¼‚æ­¥é…ç½®
    CacheModule.forRootAsync({
      useFactory: () => ({
        host: process.env.CACHE_HOST || 'localhost',
        port: parseInt(process.env.CACHE_PORT) || 6379,
        ttl: 3600000,
      }),
    }),
    
    // æˆ–è€…ä»é…ç½®æœåŠ¡åŠ è½½
    CacheModule.forRootFromConfig(),
  ],
})
export class AppModule {}
```

```typescript
// src/user/user.service.ts
import { Injectable } from '@nestjs/common';
import { CacheService } from '../cache';

@Injectable()
export class UserService {
  constructor(private readonly cacheService: CacheService) {}

  async getUser(id: string) {
    // å…ˆä»ç¼“å­˜è·å–
    const cached = this.cacheService.get(`user:${id}`);
    if (cached) {
      return cached;
    }

    // ä»æ•°æ®åº“è·å–
    const user = await this.fetchUserFromDatabase(id);
    
    // å­˜å…¥ç¼“å­˜
    this.cacheService.set(`user:${id}`, user, 1800000); // 30åˆ†é’Ÿ
    
    return user;
  }

  private async fetchUserFromDatabase(id: string) {
    // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
    return { id, name: 'Test User', email: 'test@example.com' };
  }
}
```

```typescript
// src/cache/cache.service.spec.ts
import { Test, TestingModule } from '@nestjs/testing';
import { CacheService } from './services/cache.service';
import { CacheModule } from './cache.module';

describe('CacheService', () => {
  let service: CacheService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      imports: [
        CacheModule.forRoot({
          ttl: 1000,
          prefix: 'test',
        }),
      ],
    }).compile();

    service = module.get<CacheService>(CacheService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });

  it('should set and get values', () => {
    service.set('key1', 'value1');
    expect(service.get('key1')).toBe('value1');
  });

  it('should handle expiration', (done) => {
    service.set('key2', 'value2', 100);
    
    setTimeout(() => {
      expect(service.get('key2')).toBeNull();
      done();
    }, 150);
  });
});
```

